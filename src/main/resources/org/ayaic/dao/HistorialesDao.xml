<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.ayaic.dao.HistorialesDao">
  
  <insert id="setCrearReservacion">
    update establecimientos set fecha_folio=now(),folio_far=1 where date(fecha_folio)!=date(now()) and cod_esta=#{cod_esta};
  
    insert into reservaciones (id_paciente, id_consultorio,  fecha,edad,expedido,id_estado,id_persona,id_intercon,cod_esta,id_seguro,
           vigencia,id_per_vigencia,talla,peso,temperatura,fc,pa,fr,so2,glicemia,tipoconsult,id_riesgo) 
    values ( #{id_paciente}, #{id_consultorio},#{fecha},#{edad},#{expedido},#{id_estado},#{ult_usuario},#{id_persona},#{cod_esta},#{id_seguro},
           #{id_cargo},#{id_historia},0,0,0,'0','0','0','0','0',#{tipoconsult},#{id_riesgo}) ; 
  </insert>
  
  <insert id="setCrearReservacionFicha">
     update personas set nropac=#{dial},numficha=numficha+1 where id_persona=#{ult_usuario} and cod_esta=#{cod_esta};
     
     INSERT INTO public.clientes( fec_cita, id_consultorio, id_persona, id_paciente,id_historial, cliente, grupo, prioridad, 
            fecha, hora, idusuario, nropac, id_estado, nrollamadas, atencion, abandono, terminado, cod_esta)
     VALUES (#{fecha}, #{id_consultorio}, #{ult_usuario}, #{id_paciente}, 
            (select max(id_reservacion) from reservaciones where cod_esta=#{cod_esta} and id_paciente=#{id_paciente}) , 
            #{cadena3}, #{cadena2}, 100, now(), now(), #{id_por}, #{dial}, 0, 0, 'FALSE', 'FALSE', 'FALSE', #{cod_esta}) ;
            
     update clientes set id_estado=1 where cod_esta=#{cod_esta} and id_paciente=#{id_paciente} and date(fec_cita)=date(now()) 
            and id_historial=(select max(id_reservacion) from reservaciones where cod_esta=#{cod_esta} and id_paciente=#{id_paciente}) ; 
  </insert>
  
  <insert id="setCrearInterconsulta">
      INSERT INTO interconsultas(id_paciente,id_historial,fecha, id_consultorio_d, id_persona_d, id_consultorio_a, id_persona_a,tipoconsul)
        VALUES (#{id_paciente},#{id_historial},#{fecha},#{id_historia}, #{id_persona},#{id_consultorio}, #{ult_usuario}, #{tipoconsult}) ;
  </insert>
  
  <insert id="setCrearInternado">
    update camas set estado=1 where id_cama=#{id_cama};  
    insert into historiainter (id_historial, id_consultorio,id_persona, fecha,diagnostico,id_estado,sala,cama,talla,peso,temperatura,
                              fc,pa,fr,cod_esta,fec_reg,id_piso,id_por,tipo_inter) 
                   values ( #{id_historial}, #{id_consultorio}, #{id_persona},now(),#{diagnostico},#{id_estado},#{id_sala},#{id_cama},#{talla},
                          #{peso},#{temperatura},#{fc},#{pa},#{fr},#{cod_esta},now(),#{id_piso},#{id_por},#{id_ecivil}) ;
    update cuaderno5 set sala=#{id_sala}, cama=#{id_cama}, id_piso=#{id_piso},id_historia=
                     (select max(id_historia) from historiainter where id_historial=#{id_historial} and cod_esta=#{cod_esta})
           where id_historial=#{id_historial} and cod_esta=#{cod_esta};               
  </insert>
  
  <insert id="setCrearInternado2">
    insert into historiainter (id_historial, id_consultorio,id_persona, fecha,diagnostico,id_estado,sala,cama,cod_esta,fec_reg,id_piso,id_por,tipo_inter) 
                   values ( #{id_historial}, #{id_consultorio}, #{id_persona},now(),#{diagnostico},#{id_estado},#{id_cargo},#{id_sexo},#{cod_esta},now(),#{id_piso},#{id_por},#{id_ecivil}) ;
                   
    update recetas set id_historia=(select max(id_historia) from historiainter where id_historial=#{id_historial})  where id_historial=#{id_historial};
   
    update cuaderno5 set sala=#{id_cargo}, cama=#{id_sexo}, id_piso=#{id_piso}, id_historia=
           (select max(id_historia) from historiainter where id_historial=#{id_historial} and cod_esta=#{cod_esta})
           where id_historial=#{id_historial} and cod_esta=#{cod_esta};   
           
    update camas set estado=1 where id_cama=#{id_sexo}; 
  </insert>
  
  <insert id="setCrearInternadoEmerg">
    insert into  historiaemerg(id_historial, id_consultorio, id_persona, fecha, antpato, antfami, antgineco,histoemfer,
                 evolucion, conducta, condicion, observacion,cod_esta,introduccion, ant_nopato, fisico_cabeza, fisico_cara, 
                 fisico_cuello, fisico_torax, fisico_corazon, fisico_pulmon, fisico_abdomen, fisico_extrem, fisico_genito, 
                 fisico_neuro,fec_reg,id_por,id_tipo,he_accion,he_diagnostico) 
           values ( #{id_historial}, #{id_consultorio}, #{id_persona},now(),#{cadena13},#{cadena14},#{pa},#{fc},#{registro},#{estimc},
                #{fr},#{cadena15},#{cod_esta},#{cadena1},#{cadena2},#{cadena3},#{cadena4},#{cadena5}, #{cadena6},#{cadena7},#{cadena8}, 
                #{cadena9}, #{cadena10},#{cadena11},#{cadena12},now(),#{id_por},#{id_tipo},#{cadena20},#{cadena21}) ;   
    update historiales set subjetivo=#{subjetivo},objetivo=#{objetivo},diagnostico=#{cadena21} where id_historial=#{id_historial} and cod_esta=#{cod_esta};  
    update historiales set peso=0, talla=0,fc='0',pa='0',fr='0',temperatura=0,internado=0,vigencia=0 where talla is null;
  </insert>
  
  <update id="setModificarEmergencias">
      update historiaemerg SET fecha=now(), antpato=#{cadena13}, antfami=#{cadena14}, 
             antgineco=#{pa}, histoemfer=#{fc}, evolucion=#{registro}, conducta=#{estimc}, condicion=#{fr}, observacion=#{cadena15},
             introduccion=#{cadena1},ant_nopato=#{cadena2},fisico_cabeza=#{cadena3},fisico_cara=#{cadena4},fisico_cuello=#{cadena5},
             fisico_torax= #{cadena6},fisico_corazon=#{cadena7},fisico_pulmon=#{cadena8},fisico_abdomen= #{cadena9},
             fisico_extrem= #{cadena10},fisico_genito=#{cadena11},fisico_neuro=#{cadena12},id_tipo=#{id_tipo},
             he_accion=#{cadena20},he_diagnostico=#{cadena21} 
             where id_historia = #{id_historia} and id_historial = #{id_historial} and cod_esta=#{cod_esta};
             
      update historiales set subjetivo=#{subjetivo},objetivo=#{objetivo},diagnostico=#{cadena21} where id_historial=#{id_historial} and cod_esta=#{cod_esta};   
   </update>      
  
  <insert id="setCrearMorbilidad" >
    insert into detallecie10 (id_historial, codigo,num,tipo,cod_esta,fec_reg,id_persona) 
                   values ( #{id_historial}, #{codigo}, #{id_cargo}, #{tipo}, #{cod_esta},now(),#{id_persona} ); 
  </insert>
  
  <delete id="setEliminarReserva" >
      INSERT INTO reservacionesupdate (id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, 
                 talla, peso, temperatura, fc, pa, fr, id_intercon, cod_esta, fec_reg, fechamod, modi_por, tipop, ip, nameip,
                 id_seguro,vigencia,id_per_vigencia,id_per_urgencia,triaje,tipoconsult,id_riesgo)
             (SELECT id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, talla, peso, temperatura, 
                 fc, pa, fr, id_intercon, cod_esta, fec_reg, now(),#{id_persona},#{expedido},#{accion},#{codigo}, 
                 id_seguro,vigencia,id_per_vigencia,id_per_urgencia,triaje,tipoconsult,id_riesgo 
      FROM reservaciones 
      WHERE id_reservacion = #{id_reservacion} and cod_esta=#{cod_esta});
      <!--    
      update historiales set fechavig=(select fecha from reservaciones WHERE id_reservacion=#{id_reservacion} and cod_esta=#{cod_esta} ,
             triaje=(select triaje from reservaciones WHERE id_reservacion=#{id_reservacion} and cod_esta=#{cod_esta})   
             where id_historial = #{id_reservacion} and cod_esta=#{cod_esta} and (fechavig null or fechavig='');  
      -->     
      delete from reservaciones where id_reservacion = #{id_reservacion} and cod_esta=#{cod_esta};
      UPDATE public.clientes SET id_estado=2 WHERE id_historial = #{id_reservacion} and cod_esta=#{cod_esta} and id_estado=1;
      DELETE FROM public.clientes WHERE id_historial = #{id_reservacion} and cod_esta=#{cod_esta} and id_estado=0;
  </delete> 
  
 <delete id="setEliminarMorbilidad" >
      delete from detallecie10 where id_morbilidad = #{id_historia} and cod_esta=#{cod_esta};
  </delete>
  
   <delete id="setEliminarMorbilidadFarma" >
      delete from detallecie10 where id_historial = #{id_historia} and codigo = #{codigo} and cod_esta=#{cod_esta};
  </delete>
  
 <update id="setModificarMorbilidad">
    update detallecie10
    set  tipo = #{expedido}
    where id_historial = #{id_historial} and cod_esta=#{cod_esta};
  </update>
  
  <delete id="setEliminarHistoria" >
      INSERT INTO historialesupdate (id_historial, id_paciente, id_consultorio, id_persona, fecha, diagnostico, subjetivo, objetivo, 
              id_estado, edad, rango, repetida, expedido, talla, peso, fc, pa, fr, temperatura, codigo, accion, fechalab, 
              internado, fec_reg, id_seguro, embaraza, cod_esta, vigencia, fechamod, modi_por, tipop, ip, nameip)
             (SELECT id_historial, id_paciente, id_consultorio, id_persona, fecha, diagnostico, subjetivo, objetivo, id_estado, edad, 
              rango, repetida, expedido, talla, peso, fc, pa, fr, temperatura, codigo, accion, fechalab, internado, fec_reg, 
              id_seguro, embaraza, cod_esta, vigencia, now(),#{id_provincia},#{estimc},#{cama}, #{sala} FROM historiales 
       WHERE id_historial = #{id_historial} and cod_esta=#{cod_esta}) ;
       
      delete from Historiainter where id_historial = #{id_historial} and cod_esta = #{cod_esta};
      delete from Historiaemerg where id_historial = #{id_historial} and cod_esta = #{cod_esta};
      delete from detallecie10 where id_historial = #{id_historial} and cod_esta = #{cod_esta};
      <!--delete from detallesangre where id_historial = #{id_historial};
      delete from detalleorina where id_historial = #{id_historial};
      delete from laboratorio where id_historial = #{id_historial} and cod_esta = #{cod_esta}; -->
      delete from Historiales where id_historial = #{id_historial} and cod_esta = #{cod_esta};
  </delete>  
  
  <delete id="setEliminaLab" >
      delete from Laboratorio where id_historial = #{id_historial} 
  </delete> 
  <delete id="setEliminaPedidoLab" >
      INSERT INTO laboratorioupdate (id_cuaderno, id_historial, laboratorio, resultado, id_costo,fechap, fechae, tipoconsulta, id_estado, 
                  id_persona, id_pedido, id_detalles, urgencia, id_por, id_porp, id_porr, id_historia, id_laboratorio, fec_reg, direccion,
                  cod_esta, normal, id_porb, tipom, fechamod, ip, nameip)
        (SELECT id_cuaderno, id_historial, laboratorio, resultado, id_costo, fechap, fechae, tipoconsulta, id_estado, id_persona, 
                id_pedido, id_detalles, urgencia, id_por, id_porp, id_porr, id_historia, id_laboratorio, fec_reg, direccion, cod_esta, 
                normal, #{id_persona},'E',now(),#{cadena1},#{cadena2} 
        FROM laboratorio 
        WHERE id_pedido=#{id_pedido} and cod_esta=#{cod_esta}) ;
        
        INSERT INTO pedidoslabupdate (id_pedido, fechap, nombres, establecimiento, id_historial, id_historia,id_estado, id_persona, 
                  id_dispensa, fechae, tipo, numero, urgencia, id_paciente, fec_reg, cod_esta, id_por, tipom, ip, nameip, fechamod)
        (SELECT id_pedido, fechap, nombres, establecimiento, id_historial, id_historia, id_estado, id_persona, id_dispensa, 
                fechae, tipo, numero, urgencia, id_paciente, fec_reg, cod_esta, #{id_persona},'E',#{cadena1},#{cadena2},now() 
        FROM pedidoslab 
        WHERE id_pedido=#{id_pedido} and cod_esta=#{cod_esta}) ;
        
      delete from Laboratorio where id_pedido = #{id_pedido} and cod_esta=#{cod_esta};
      delete from pedidoslab where id_pedido = #{id_pedido} and cod_esta=#{cod_esta};
  </delete> 
  
   <update id="setModificaLab" >
    update historiales
       set  expedido=#{expedido},fechalab=#{fecha} 
       where id_historial = #{id_historial};
    update laboratorio
       set  id_estado=#{id_estado},fechae=#{fecha} 
       where id_historial = #{id_historial};
    update pedidoslab
       set  fechae=#{fecha}
       where id_historial = #{id_historial};   
    update recetass
       set  fecha=#{fecha}
       where id_historial = #{id_historial} and (prestacion like 'PL%' or prestacion like 'IG%');   
  </update>
  
  <update id="setModificarPagoReserva" >
    update reservaciones  set  id_estado =  #{id_estado}  where id_reservacion = #{id_reservacion} and cod_esta = #{cod_esta} 
  </update>
  
   <update id="setModificaVigencia" >
    update reservaciones  set  vigencia =  #{id_cargo}, id_riesgo =  #{id_riesgo}, tipoconsult =  #{tipoconsult}  
           where id_reservacion = #{id_reservacion} and cod_esta=#{cod_esta};
    update historiales  set  vigencia =  #{id_cargo}, id_riesgo =  #{id_riesgo}, tipoconsult =  #{tipoconsult} 
           where id_historial = #{id_reservacion} and cod_esta=#{cod_esta};
  </update>
  
  <update id="setModificarInter" >
      update recetas
    set  id_estado = #{id_estado}      
    where id_estado='A' and cod_esta=#{cod_esta} and id_historia!=0 and id_historia in
      (select id_historia from recetas  where id_estado='A' and id_historia=#{id_historia} and cod_esta=#{cod_esta}) ;
      
    update historiainter set id_estado=#{id_estado} where cod_esta=#{cod_esta} and id_historia in
      (select id_historia from recetas  where id_estado='A' and id_historia=#{id_historia} and cod_esta=#{cod_esta}) ;
   </update>
   
   <update id="setModificarInterReceta" >
    update historiainter set id_estado=#{id_estado} where cod_esta=#{cod_esta} and id_historia in
      (select id_historia from recetas  where id_estado='A' and id_historia=#{id_historia} and cod_esta=#{cod_esta}) ;
   </update>
   
   <update id="setModificarInterFecha" >
      INSERT INTO public.historiainterupdate(id_historia, id_historial, id_consultorio, id_persona, fecha, diagnostico, id_estado,sala, 
             cama, talla, peso, temperatura,fc, pa, fr, cod_esta, fec_reg, id_por, id_piso, tipo_inter,fechamod,modi_por,ip,nameip)
      (SELECT id_historia, id_historial, id_consultorio, id_persona, fecha, diagnostico, id_estado, sala, cama, talla, peso,temperatura, 
             fc, pa, fr, cod_esta, fec_reg, id_por, id_piso, tipo_inter, now(), #{id_persona},#{cadena1},#{cadena2} 
       FROM public.historiainter where id_historia = #{id_historia} and id_historial = #{id_historial} and cod_esta=#{cod_esta} and 
            diagnostico!=#{diagnostico}) ;
 
      update historiainter set fecha=#{fecha},diagnostico=#{diagnostico}, talla=#{talla}, peso=#{peso}, fc=#{fc},
          temperatura=#{temperatura}, pa=#{pa}, fr=#{fr}, id_persona=#{id_persona}, id_consultorio=#{id_consultorio}  
      where id_historia=#{id_historia} and id_historial=#{id_historial} and cod_esta=#{cod_esta};
   </update>
  
   <update id="setModificarInterDat" >
    update camas set estado=0 where id_cama=#{id_cama};
    update camas set estado=1 where id_cama=#{id_carpeta};    
    update historiainter set  sala = #{id_sala}, cama = #{id_carpeta},id_piso = #{id_piso},id_consultorio = #{id_consultorio},
           id_persona = #{id_persona},tipo_inter = #{id_tipo}   where id_historia = #{id_historia} and cod_esta=#{cod_esta};   
    update cuaderno5 set sala=#{id_sala},cama=#{id_carpeta},id_piso=#{id_piso},id_persona=#{id_persona},id_consultorio=#{id_consultorio} 
           where id_historial=#{id_historial} and cod_esta=#{cod_esta};
    update historiales set internado=#{id_tipo} where id_historial = #{id_historial} and cod_esta=#{cod_esta};
    update recetas set id_persona=#{id_persona} where id_historia = #{id_historia} and cod_esta=#{cod_esta};
  </update>
  
  <update id="setModificarInterDatHisto">
    update historiales set internado=3 where internado=2 and id_paciente=#{id_paciente} and cod_esta!=#{cod_esta};
  </update>
  
  <update id="setModificarInterAltaHisto">
     update historiales set internado=9 where cod_esta=#{cod_esta} and  internado in (select id_tipoi from tipos_inter where internado=2 ) and 
     id_historial not in (select id_historial from historiainter where cod_esta=#{cod_esta} and fecha>current_date-5 and id_historial in 
     (select id_historial from historiales where cod_esta=#{cod_esta} and  internado in (select id_tipoi from tipos_inter where internado=2 ) ));
      
    update camas set estado=0 where cod_esta=#{cod_esta} and id_cama not in 
    (select id_cama from camas where cod_esta=#{cod_esta} and id_cama in 
    (select cama from cuaderno5 
    join historiales h using(id_historial)
    where h.cod_esta=#{cod_esta} and internado in (select id_tipoi from tipos_inter where internado=2 ) ) );
    <!-- eliminaciones tablas  -->
    insert into reservacionesupdate
      (SELECT id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, 
           id_estado, id_persona, talla, peso, temperatura, fc, pa, fr, 
           id_intercon, cod_esta, id_seguro, vigencia, id_per_vigencia, 
           id_per_urgencia, fec_reg, now(), 1, 'M', '127.0.0.1', 'SEVER',triaje,id_riesgo,tipoconsult
      FROM reservaciones where fecha between (current_date-10) and (current_date - 1) );
      delete from reservaciones where fecha between (current_date-10) and (current_date - 1);

    update historiales set internado=#{internado} 
    where id_paciente=#{id_paciente} and id_historial=#{id_historial} and cod_esta=#{cod_esta};
  </update>
  
   <update id="setModificarReservaConsultorio" >
       INSERT INTO reservacionesupdate (id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, 
                    talla, peso, temperatura, fc, pa, fr,so2,glicemia, id_intercon, cod_esta,id_seguro,vigencia, id_per_urgencia,id_per_vigencia,fec_reg, 
                    fechamod, modi_por, tipop, ip, nameip,triaje,id_riesgo,tipoconsult)
             (SELECT id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, 
                    talla, peso, temperatura, fc, pa, fr,so2,glicemia, id_intercon, cod_esta,id_seguro,vigencia, id_per_urgencia,id_per_vigencia,fec_reg, 
                    now(), #{id_persona},#{expedido},#{accion},#{codigo},triaje,id_riesgo,tipoconsult 
              FROM reservaciones WHERE id_reservacion = #{id_reservacion} and cod_esta=#{cod_esta}) ;
        UPDATE reservaciones SET  id_consultorio = #{id_consultorio},id_persona=#{id_persona}, fecha=#{fecha},id_riesgo=#{id_riesgo},tipoconsult=#{tipoconsult}
        WHERE id_reservacion = #{id_reservacion} and cod_esta=#{cod_esta};
  </update>
  
  <update id="setModificarReservaTotal" >
       INSERT INTO reservacionesupdate (id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, 
                    talla, peso, temperatura, fc, pa, fr,so2,glicemia, id_intercon, cod_esta,id_seguro,vigencia, id_per_urgencia,id_per_vigencia,fec_reg, 
                    fechamod, modi_por, tipop, ip, nameip,triaje,id_riesgo,tipoconsult)
             (SELECT id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, 
                    talla, peso, temperatura, fc, pa, fr,so2,glicemia, id_intercon, cod_esta,id_seguro,vigencia, id_per_urgencia,id_per_vigencia,fec_reg, 
                    now(), #{id_persona},#{expedido},#{cadena},#{codigo},triaje,id_riesgo,tipoconsult 
              FROM reservaciones WHERE id_consultorio =#{id_reservacion} and id_persona=#{id_historia}  and cod_esta=#{cod_esta} and 
              fecha::timestamp without time zone BETWEEN #{fecha_ini} and #{fecha_fin}) ;
        
      UPDATE reservaciones SET  id_consultorio = #{id_consultorio},id_persona=#{id_persona}
        WHERE id_consultorio =#{id_reservacion} and id_persona=#{id_historia}  and cod_esta=#{cod_esta} and 
              fecha::timestamp without time zone BETWEEN #{fecha_ini} and #{fecha_fin};
  </update>
  
  <update id="setModificarReservaVigencia" >
        INSERT INTO reservacionesupdate (id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, 
                    talla, peso, temperatura, fc, pa, fr, id_intercon, cod_esta,id_seguro,vigencia, id_per_urgencia,id_per_vigencia,fec_reg, 
                    fechamod, modi_por, tipop, ip, nameip,triaje,id_riesgo,tipoconsult)
             (SELECT id_reservacion, id_paciente, id_consultorio, fecha, edad, expedido, id_estado, id_persona, 
                    talla, peso, temperatura, fc, pa, fr, id_intercon, cod_esta,id_seguro,vigencia, id_per_urgencia,id_per_vigencia,fec_reg, 
                    now(), #{id_persona},#{expedido},#{accion},#{codigo},triaje,id_riesgo,tipoconsult 
              FROM reservaciones WHERE id_reservacion = #{id_reservacion} and cod_esta=#{cod_esta}) ;
        UPDATE reservaciones
           SET  id_consultorio = #{id_consultorio},id_persona=#{id_persona},id_per_urgencia=#{id_historia}, fecha=#{fecha},triaje=#{id_tipo#{
        WHERE id_reservacion = #{id_reservacion} and cod_esta=#{cod_esta};
  </update>
  
   <update id="setModificarEstadoHistorial">
       INSERT INTO historialesupdate (id_historial, id_paciente, id_consultorio, id_persona, fecha, diagnostico, subjetivo, objetivo, 
              id_estado, edad, rango, repetida, expedido, talla, peso, fc, pa, fr, temperatura, codigo, accion, fechalab, internado, 
              fec_reg, id_seguro, embaraza, cod_esta, vigencia, fechamod, modi_por, tipop, ip, nameip)
             (SELECT id_historial, id_paciente, id_consultorio, id_persona, fecha, diagnostico, subjetivo, objetivo, 
              id_estado, edad, rango, repetida, expedido, talla, peso, fc, pa, fr, temperatura, codigo, accion, fechalab, internado, 
              fec_reg, id_seguro, embaraza, cod_esta, vigencia, now(),#{id_provincia},#{estimc},#{cama}, #{sala} FROM historiales 
       WHERE id_historial = #{id_historial} and cod_esta=#{cod_esta}) ;
       
       INSERT INTO detalleupdate(id_detalle, fecha, entrada, salida, expedido, id_costo, id_pedido,id_estado, indicacion, 
               id_rubro,id_factura,fec_reg, id_por,tipo,ip,nameip,fec_mod)
        (SELECT id_detalle, fecha, entrada, salida, expedido, id_costo, id_pedido,id_estado, indicacion, id_rubro,id_factura,
               fec_reg,#{id_provincia},'M',#{cama}, #{sala},now() FROM detalle WHERE id_pedido in (select id_pedido from pedidos 
                                             WHERE id_historial = #{id_historial} and cod_esta=#{cod_esta} and id_factura=0) );
       
       INSERT INTO pedidosupdate (id_pedido,nombres, nit, fec_registro,precio_total,id_historial,id_estado,num_cladoc,
                          id_rubro,id_persona,id_dispensa,tipo,id_factura,id_paciente,id_historia,fec_reg,id_por,tipom,
                          ip,nameip,fechamod)
             (SELECT id_pedido,nombres,nit,fec_registro,precio_total,id_historial,id_estado,num_cladoc,id_rubro,id_persona,
                id_dispensa,tipo,id_factura,id_paciente,id_historia,fec_reg,#{id_provincia},'M',#{cama}, #{sala},now() 
        FROM pedidos 
        WHERE id_historial = #{id_historial} and cod_esta=#{cod_esta} and id_factura=0);
  
       update historiales
         set  id_estado = #{id_estado},expedido=#{expedido},fecha=#{fecha}, fechalab=#{fecha}, edad=#{edad},internado=#{id_cargo},
             id_seguro=#{id_seguro},id_persona=#{id_persona},id_consultorio=#{id_consultorio} 
       where id_historial = #{id_historial} and cod_esta=#{cod_esta};
       update recetass
         set fecha=#{fecha},id_persona=#{id_persona} where id_historial = #{id_historial} and cod_esta=#{cod_esta};
       update recetas
         set fecha=#{fecha}, expedido=#{expedido},id_persona=#{id_persona} where id_historial = #{id_historial} and cod_esta=#{cod_esta};
       update vacunas
         set fechap=#{fecha},id_persona=#{id_persona} where id_historial = #{id_historial};
       update cuaderno6
         set fechap=#{fecha},id_persona=#{id_persona} where id_historial = #{id_historial};
       update detalle
         SET fecha=#{fecha} WHERE id_pedido in (select id_pedido from pedidos 
                                             WHERE id_historial = #{id_historial} and cod_esta=#{cod_esta} and id_factura=0);
       update pedidos SET id_estado=#{expedido} 
              WHERE id_historial = #{id_historial} and cod_esta=#{cod_esta} and id_factura=0;  
  </update>
  
  <update id="setModificarInternado">
      update historiales set internado = #{id_cargo}  where id_historial = #{id_historial} and cod_esta=#{cod_esta};
      update camas set estado=0 where id_cama=(select cama from cuaderno5 where id_historial=#{id_historial} and cod_esta=#{cod_esta}) ;
      <!--internado=0 solo cambia de los consulta esterna si ya fue internadono debe cambiar -->
   </update>
   
   <update id="setModificarInternadoFecha">
      INSERT INTO historialesupdate (id_historial, id_paciente, id_consultorio, id_persona, fecha, diagnostico, subjetivo, objetivo, 
              id_estado, edad, rango, repetida, expedido, talla, peso, fc, pa, fr, temperatura, codigo, accion, fechalab, internado, 
              fec_reg, id_seguro, embaraza, cod_esta, vigencia, fechamod, modi_por, tipop, ip, nameip)
             (SELECT id_historial, id_paciente, id_consultorio, id_persona, fecha, diagnostico, subjetivo, objetivo, 
              id_estado, edad, rango, repetida, expedido, talla, peso, fc, pa, fr, temperatura, codigo, accion, fechalab, internado, 
              fec_reg, id_seguro, embaraza, cod_esta, vigencia, now(),#{id_provincia},#{estimc},#{cama}, #{sala} FROM historiales 
       WHERE id_historial = #{id_historial} and cod_esta=#{cod_esta}) ; 
       
      update cuaderno5 set fec_ingreso=#{fec_ingreso}, fec_egreso=#{fec_egreso}  where id_historial = #{id_historial} and cod_esta=#{cod_esta};
      <!--update historiales set fecha=#{fec_ingreso} where id_historial = #{id_historial} and cod_esta=#{cod_esta};
      update recetas set fecha=#{fec_ingreso} where id_historial = #{id_historial} and cod_esta=#{cod_esta};
      update recetass set fecha=#{fec_ingreso} where id_historial = #{id_historial} and cod_esta=#{cod_esta};
      esto cambiaba la fecha de historial y si se equivocan chau dato no se puede hacer eso en historiales que sea manual-->
      update historiainter set fecha=#{fec_ingreso} where id_historia =
             (select min(id_historia) as id_historia from historiainter where id_historial=#{id_historial} and cod_esta=#{cod_esta}) ;
      update historiainter set fecha=#{fec_egreso} where id_historia =
             (select max(id_historia) as id_historia from historiainter where id_historial=#{id_historial} and cod_esta=#{cod_esta}) ;
   </update>
  
  <resultMap id="datoPacienteCIE"   type="Historiales">
    <result property="hcl"               column="hcl"/>   
    <result property="id_persona"        column="id_persona"/>  
    <result property="id_consultorio"    column="id_consultorio"/>
    <result property="fecha"             column="fecha"/>
    <result property="edad_ini"          column="edad_ini"/>
    <result property="id_reservacion"    column="id_reservacion"/>
    <result property="nombres"           column="nombres"/>
    <result property="id_paciente"       column="id_paciente"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="expedido"          column="expedido"/>   
    <result property="nombre"            column="nombre"/> 
    <result property="id_seguro"         column="id_seguro"/> 
    <result property="codigo"            column="codigo"/> 
    <result property="resultado"         column="resultado"/> 
  </resultMap>
  
  <select id="getListarReservacionesCIE10" resultMap="datoPacienteCIE">
  (SELECT hcl,id_persona,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
                (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, p.id_seguro,'' as codigo,'' as resultado
         FROM reservaciones r 
         JOIN pacientes p USING(id_paciente)
         JOIN consultorios c USING(id_consultorio)
         JOIN personas e USING(id_persona)
         where fecha::date between #{fecha_ini} and #{fecha_fin} 
         order by codigo,r.fecha,nombre)
   UNION
   (SELECT hcl,id_persona,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_historial as id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
                (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,codigo,diagnostico as resultado
         FROM historiales r 
         JOIN pacientes p USING(id_paciente)
         JOIN consultorios c USING(id_consultorio)
         JOIN personas e USING(id_persona)
         where fecha::date between #{fecha_ini} and #{fecha_fin} 
         order by codigo,r.fecha,nombre)
    order by id_consultorio,id_persona,fecha,nombre  
  </select>
  
  <select id="getListarReservacionesCIE10Consul" resultMap="datoPacienteCIE">
  (SELECT hcl,id_persona,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
                (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, p.id_seguro,'' as codigo,'' as resultado
         FROM reservaciones r 
         JOIN pacientes p USING(id_paciente)
         JOIN consultorios c USING(id_consultorio)
         JOIN personas e USING(id_persona)
         where fecha::date=current_date and r.id_consultorio=#{id_consultorio} 
         order by codigo,r.fecha,nombre)
   UNION
   (SELECT hcl,id_persona,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_historial as id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
                (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,codigo,diagnostico as resultado
         FROM historiales r 
         JOIN pacientes p USING(id_paciente)
         JOIN consultorios c USING(id_consultorio)
         JOIN personas e USING(id_persona)
         where fecha::date=current_date and r.id_consultorio=#{id_consultorio} 
         order by codigo,r.fecha,nombre)
    order by codigo,fecha,nombre  
  </select>
  
  <select id="getListarReservacionesCIE10ConsulE" resultMap="datoPacienteCIE">
  (SELECT hcl,id_persona,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
                (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, p.id_seguro,'' as codigo,'' as resultado
         FROM reservaciones r 
         JOIN pacientes p USING(id_paciente)
         JOIN consultorios c USING(id_consultorio)
         JOIN personas e USING(id_persona)
         where fecha::date=current_date and r.id_persona=#{id_persona} 
         order by codigo,r.fecha,nombre)
   UNION
   (SELECT hcl,id_persona,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_historial as id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
                (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,codigo,diagnostico as resultado
         FROM historiales r 
         JOIN pacientes p USING(id_paciente)
         JOIN consultorios c USING(id_consultorio)
         JOIN personas e USING(id_persona)
         where fecha::date=current_date and r.id_persona=#{id_persona} 
         order by codigo,r.fecha,nombre)
    order by codigo,fecha,nombre  
  </select>
  
   <resultMap id="datoPacienteVig"   type="Historiales">
    <result property="hcl"               column="hcl"/>   
    <result property="id_consultorio"    column="id_consultorio"/>   
    <result property="fecha"             column="fecha"/>
    <result property="edad_ini"          column="edad_ini"/>
    <result property="id_reservacion"    column="id_reservacion"/>
    <result property="nombres"           column="nombres"/>
    <result property="id_paciente"       column="id_paciente"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="expedido"          column="expedido"/>   
    <result property="nombre"            column="nombre"/> 
    <result property="id_seguro"         column="id_seguro"/> 
    <result property="id_persona"        column="id_persona"/> 
    <result property="id_historia"       column="id_historia"/> 
    <result property="nro"               column="nro"/> 
    <result property="nro_registro"      column="nro_registro"/> 
    <result property="suma1"             column="suma1"/> 
    <result property="suma70"            column="suma70"/> 
    <result property="cadena4"           column="cadena4"/> 
    <result property="carnet"            column="carnet"/>
    <result property="codestaref"        column="codestaref"/>
    <result property="nombrecodestared"  column="nombrecodestared"/>
    <result property="cadena2"           column="cadena2"/>
    <result property="tipoconsult"          column="tipoconsult"/>
    <result property="id_riesgo"             column="id_riesgo"/>
    <result property="cod_esta"              column="cod_esta"/>
  </resultMap>
  
  <select id="getListarVigenciaFicha" resultMap="datoPacienteVig">
     SELECT hcl,0 as id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
            nomconsul as consultorio, r.expedido,substring((trim(e.nombres) ||' '|| trim(e.paterno) ||' '|| trim(e.materno)),1,26) as nombre, r.id_seguro, e.id_persona, 
            vigencia as id_historia, codcns as nro,nro_registro,0 as suma1,0 as suma70,cliente as cadena4,
            carnet,codestaref,nombrecodestared,seguro as cadena2,tipoconsult,id_riesgo,r.cod_esta 
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN personas e USING(id_persona)
     INNER JOIN clientes c on id_historial=id_reservacion
     where r.cod_esta=#{cod_esta} and r.id_reservacion in (select max(id_reservacion) from reservaciones where cod_esta=#{cod_esta}
           and id_paciente=#{id_paciente} and id_consultorio=#{id_consultorio}) 
  </select>
  
  <select id="getListarVigencia" resultMap="datoPacienteVig">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
            consultorio, r.expedido,'Vigencia' as nombre, r.id_seguro, id_persona, vigencia as id_historia,
            codcns as nro,nro_registro,0 as suma1,cod_patronal as suma70,empresa as cadena4, carnet,codestaref,
            nombrecodestared,seguro as cadena2,tipoconsult,id_riesgo,r.cod_esta
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN empresas e USING(id_empresa)
     where r.cod_esta= #{cod_esta} and vigencia between #{id_historia} and #{id_historial} and fecha::date=current_date
     order by r.fecha desc,id_reservacion desc,nombre limit 50
  </select>
  
   <select id="getListarVigenciaHab" resultMap="datoPacienteVig">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
            consultorio, r.expedido,'Vigencia' as nombre, r.id_seguro, id_persona, vigencia as id_historia,
            codcns as nro,nro_registro,0 as suma1,cod_patronal as suma70,empresa as cadena4, carnet,codestaref,
            nombrecodestared, seguro as cadena2,tipoconsult,id_riesgo,r.cod_esta
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN empresas e USING(id_empresa)
     where r.cod_esta= #{cod_esta} and vigencia between #{id_historia} and #{id_historial} and id_consultorio=0 and id_persona=0
     order by id_reservacion desc,nombre  limit 50
  </select>
  
  <select id="getListarVigenciaHabCambioConsul" resultMap="datoPacienteVig">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
            consultorio, r.expedido,(e.nombres||' '||e.paterno||' '||e.materno) as nombre, r.id_seguro, id_persona, vigencia as id_historia,
            codcns as nro,nro_registro,0 as suma1,cod_patronal as suma70,empresa as cadena4 , carnet,codestaref,
            nombrecodestared, seguro as cadena2,tipoconsult,id_riesgo,r.cod_esta
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     JOIN empresas m USING(id_empresa)
     where r.cod_esta= #{cod_esta} and (vigencia between #{id_historia} and #{id_historial})  and (fecha::date between current_date-2 and current_date)
     order by id_reservacion desc,nombre  limit 30
  </select>
  
  <select id="getListarVigenciaMedico" resultMap="datoPacienteVig">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
            consultorio, r.expedido,'Vigencia' as nombre, r.id_seguro, id_persona, vigencia as id_historia,
            codcns as nro,nro_registro,0 as suma1,cod_patronal as suma70,empresa as cadena4 , carnet,codestaref,
            nombrecodestared, seguro as cadena2,tipoconsult,id_riesgo,r.cod_esta
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     JOIN empresas m USING(id_empresa)
     where r.id_consultorio=#{id_consultorio} and r.id_persona=#{id_persona} and r.cod_esta= #{cod_esta} 
            and (vigencia between #{id_historia} and #{id_historial})  and (fecha::date between current_date-2 and current_date)
     order by r.fecha,id_reservacion,nombre
     limit 50
     <!-- esto para los medicos que atenderan-->
  </select>
  
  <select id="getListarVigenciaConsul" resultMap="datoPacienteVig">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
            consultorio, r.expedido,'Vigencia' as nombre, r.id_seguro, id_persona, vigencia as id_historia,
            codcns as nro,nro_registro,0 as suma1,cod_patronal as suma70,empresa as cadena4 , carnet,codestaref,
            nombrecodestared, seguro as cadena2,tipoconsult,id_riesgo,r.cod_esta
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     JOIN empresas m USING(id_empresa)
     where r.id_consultorio=#{id_consultorio} and r.cod_esta= #{cod_esta} and (vigencia between #{id_historia} and #{id_historial}) 
          and (fecha::date between current_date-2 and current_date)
     order by r.fecha desc,id_reservacion,nombre
     limit 50
  </select>
  
  <resultMap id="datoPacienteCountFic"   type="Historiales">
    <result property="hcl"          column="hcl"/>   
    <result property="id_persona"          column="id_persona"/>   
    <result property="id_consultorio"      column="id_consultorio"/>  
    <result property="id_historial"        column="id_historial"/>  
    <result property="id_paciente"         column="id_paciente"/> 
    <result property="fecha"               column="fecha"/>  
    <result property="nombres"             column="nombres"/>  
    <result property="nombre"              column="nombre"/>  
    <result property="cadena1"             column="cadena1"/>  
    <result property="cadena2"             column="cadena2"/>  
    <result property="cadena3"             column="cadena3"/>  
    <result property="suma1"               column="suma1"/>  
    <result property="suma2"               column="suma2"/>  
  </resultMap>
  
  <select id="getListarReserFichas" resultMap="datoPacienteCountFic">
     SELECT hcl,e.id_persona,c.id_consultorio,fec_cita::timestamp as fecha,id_historial,p.id_paciente, p.nombres,nomconsul as cadena1, 
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre,  inicial as cadena2,cliente as cadena3,nrollamadas as suma2,
             count(*) OVER() as suma1
     FROM clientes c 
     JOIN pacientes p USING(id_paciente)
     JOIN personas e USING(id_persona)
     where c.id_estado=1 and c.cod_esta=#{cod_esta} and c.id_consultorio=#{id_consultorio} and c.id_persona=#{id_persona} and date(fecha)=current_date
     order by fec_cita
  </select>
  
  <resultMap id="datoPacienteCount"   type="Historiales">
    <result property="id_persona"          column="id_persona"/>   
    <result property="nombre"              column="nombre"/>   
    <result property="cod_esta"            column="cod_esta"/>   
    <result property="suma1"               column="suma1"/>
  </resultMap>
  
  <select id="getListarReservacionesCount" resultMap="datoPacienteCount">
     SELECT id_persona,(e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.cod_esta,count(*) as suma1
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where r.id_estado like #{id_estado} and r.cod_esta=#{cod_esta} and (fecha::timestamp with time zone BETWEEN #{fecha_ini} and #{fecha_fin}) 
     group by id_persona,(e.nombres ||' '|| e.paterno ||' '|| e.materno), r.cod_esta 
  </select>
     
  <select id="getListarReservacionesCountMed" resultMap="datoPacienteCount">
     SELECT id_persona,(e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.cod_esta,count(*) as suma1
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where r.id_estado like #{id_estado} and r.cod_esta=#{cod_esta} and (r.id_consultorio between #{id_consultorio} and #{id_departamento})  and
           (fecha::timestamp with time zone BETWEEN #{fecha_ini} and #{fecha_fin}) and (r.id_persona between #{id_persona} and #{id_localidad})   
     group by id_persona,(e.nombres ||' '|| e.paterno ||' '|| e.materno), r.cod_esta 
  </select>
  
  <resultMap id="datoPacienteInter"   type="Historiales">
    <result property="hcl"               column="hcl"/>   
    <result property="id_consultorio"    column="id_consultorio"/>   
    <result property="fecha"             column="fecha"/>
    <result property="edad_ini"          column="edad_ini"/>
    <result property="id_reservacion"    column="id_reservacion"/>
    <result property="id_paciente"       column="id_paciente"/>
    <result property="expedido"          column="expedido"/>   
    <result property="nombres"           column="nombres"/> 
    <result property="id_seguro"         column="id_seguro"/> 
    <result property="id_persona"        column="id_persona"/> 
    <result property="nro"               column="nro"/> 
    <result property="nro_registro"      column="nro_registro"/> 
    <result property="carnet"            column="carnet"/> 
    <result property="telefono"          column="telefono"/> 
    <result property="id_empresa"        column="id_empresa"/> 
    <result property="cadena1"           column="cadena1"/> 
    <result property="cadena2"           column="cadena2"/> 
    <result property="tipoconsult"       column="tipoconsult"/> 
    <result property="id_riesgo"         column="id_riesgo"/> 
  </resultMap>
  
  <select id="getListarReservacionesInternet" resultMap="datoPacienteInter">
    (SELECT hcl,id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,r.expedido,
           r.id_seguro,r.id_persona,codcns as nro,
           nro_registro,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,
           seguro as cadena2,tipoconsult,1 as id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     where  fecha::timestamp between (now()::timestamp - interval '10 hours') and (now()::timestamp + interval '20 hours') and 
     r.id_persona in (select id_persona from reservaciones 
                     where fecha::timestamp between (now()::timestamp - interval '10 hours') and (now()::timestamp + interval '20 hours') and
                     id_paciente in (SELECT id_paciente FROM pacientes   WHERE nro_registro in  
    (select nro_registro FROM pacientes WHERE  id_paciente!=0 and id_seguro=35 and texto_vector @@ to_tsquery('spanish',#{nombres}) ))))
    UNION
    (SELECT hcl,id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,r.expedido,
               r.id_seguro,r.id_persona,codcns as nro,
               nro_registro,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,
               seguro as cadena2,tipoconsult,0 as id_riesgo
         FROM reservacionesupdate r 
         JOIN pacientes p USING(id_paciente)
         where  fecha::timestamp between (now()::timestamp - interval '10 hours') and (now()::timestamp + interval '20 hours') and 
         r.id_persona in (select id_persona from reservaciones 
                         where fecha::timestamp between (now()::timestamp - interval '10 hours') and (now()::timestamp + interval '20 hours') and
                         id_paciente in (SELECT id_paciente FROM pacientes   WHERE nro_registro in  
       (select nro_registro FROM pacientes WHERE  id_paciente!=0 and id_seguro=35 and texto_vector @@ to_tsquery('spanish',#{nombres}) ))))
       order by fecha,id_reservacion
  </select>
  
   <resultMap id="datoPaciente"   type="Historiales">
    <result property="hcl"               column="hcl"/>   
    <result property="id_consultorio"    column="id_consultorio"/>   
    <result property="fecha"             column="fecha"/>
    <result property="edad_ini"          column="edad_ini"/>
    <result property="id_reservacion"    column="id_reservacion"/>
    <result property="nombres"           column="nombres"/>
    <result property="id_paciente"       column="id_paciente"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="expedido"          column="expedido"/>   
    <result property="nombre"            column="nombre"/> 
    <result property="id_seguro"         column="id_seguro"/> 
    <result property="id_persona"        column="id_persona"/> 
    <result property="id_historia"       column="id_historia"/> 
    <result property="nro"               column="nro"/> 
    <result property="nro_registro"      column="nro_registro"/> 
    <result property="suma1"             column="suma1"/> 
    <result property="suma2"             column="suma2"/> 
    <result property="suma3"             column="suma3"/> 
    <result property="suma4"             column="suma4"/> 
    <result property="carnet"            column="carnet"/> 
    <result property="telefono"          column="telefono"/> 
    <result property="id_empresa"        column="id_empresa"/> 
    <result property="cadena1"           column="cadena1"/> 
    <result property="codestaref"        column="codestaref"/> 
    <result property="nombrecodestared"  column="nombrecodestared"/>
    <result property="id_tipo"           column="id_tipo"/> 
    <result property="cadena2"           column="cadena2"/> 
    <result property="cadena3"           column="cadena3"/> 
    <result property="tipoconsult"       column="tipoconsult"/> 
    <result property="id_riesgo"         column="id_riesgo"/> 
  </resultMap>
  
  <select id="getListarReservaciones" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as  suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,
           0 as suma3,0 as suma4,tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio}  and r.cod_esta=#{cod_esta} 
           and (r.id_estado like #{id_estado})  and r.id_persona=#{id_persona} and 
           fecha::timestamp between (now()::timestamp - interval '14 hours') and (now()::timestamp + interval '10 hours')
     order by r.fecha,id_reservacion,nombre
     <!--debe tener id_persona=0 sino no muestra nada -->
  </select>
  
  <select id="getListarReservacionesAsig" resultMap="datoPaciente">
    (SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,1 as  suma1,carnet,id_empresa,lower(nempresa) as cadena1,codestaref,''::text as nombrecodestared,
           triaje as id_tipo,seguro as cadena2,p.telefono,''::text as cadena3,0 as suma2,0 as suma3,0 as suma4,tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where (r.id_estado like #{id_estado}) and (r.fecha::timestamp with time zone BETWEEN #{fecha_ini} and #{fecha_fin}) and
           r.cod_esta=#{cod_esta} and r.id_persona = #{id_por})
    UNION     
   (SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_historial as id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,0 as  suma1,carnet,id_empresa,lower(nempresa) as cadena1,0 as codestaref,codigo as nombrecodestared,
           (SELECT   count(*) AS Expr1 from public.cuaderno1 WHERE id_historial = r.id_historial ) AS id_tipo,seguro as cadena2,
           (SELECT   literal AS Expr1 from public.cie10 WHERE codigo = r.codigo ) AS telefono,diagnostico as cadena3,n_rec as suma2,
           n_exa as suma3, n_ima as suma4,tipoconsult,id_riesgo
     FROM historiales r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where (r.id_estado like #{id_estado}) and (r.fecha::timestamp with time zone BETWEEN #{fecha_ini} and #{fecha_fin}) and
           r.diagnostico!='Desde Farmacia' and r.cod_esta=#{cod_esta} and r.id_persona = #{id_por})
     order by suma1,fecha  
  </select>
  
  <select id="getListarReservacionesConsul2" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro, id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_estado like #{id_estado} and r.cod_esta=#{cod_esta} and (fecha::timestamp without time zone BETWEEN #{fecha_ini} and #{fecha_fin})
     order by r.fecha desc,id_reservacion,nombre
     limit 50
  </select>
  
  <select id="getListarReservacionesCaja" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as  suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio} and r.cod_esta=#{cod_esta} and r.id_persona=#{id_persona} and 
           fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesNombreCaja" resultMap="datoPaciente">
   SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as  suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where  r.cod_esta=#{cod_esta} and 
            fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
            and r.id_persona in 
      (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)  and id_paciente in
     (select id_paciente from pacientes p join reservaciones using(id_paciente) 
     where fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours') 
           and id_persona in 
      (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
      and cod_esta=#{cod_esta} and texto_vector @@ to_tsquery('spanish', lower(#{cadena})  ) )
     order by r.fecha,id_reservacion,nombre  limit 10     
  </select>
  
  <select id="getListarReservacionesResid" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
           consultorio, r.expedido,(e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,r.id_persona,
           vigencia as id_historia,codcns as nro,nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,
           lower(nempresa) as cadena1,codestaref,nombrecodestared,triaje as id_tipo,seguro as cadena2,
           (u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where (r.id_estado like #{id_estado})   and r.cod_esta=#{cod_esta} and vigencia=1 and r.id_persona!=0 and 
           fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesHemo" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
           consultorio, r.expedido,(e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,r.id_persona,
           vigencia as id_historia,codcns as nro,nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,
           lower(nempresa) as cadena1,codestaref,nombrecodestared,triaje as id_tipo,seguro as cadena2,
           (u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where (r.id_estado like #{id_estado})   and r.cod_esta=#{cod_esta} and r.id_consultorio=84 and 
           (fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours') ) 
           and r.id_persona=#{id_persona}
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesUcaLuo" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
           consultorio, r.expedido,(e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro,r.id_persona,
           vigencia as id_historia,codcns as nro,nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,
           lower(nempresa) as cadena1,codestaref,nombrecodestared,triaje as id_tipo,seguro as cadena2,
           (u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where (r.id_estado like #{id_estado}) and r.cod_esta=#{cod_esta} and r.id_consultorio=23 and 
           (fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '72 hours')) 
           and r.id_persona=1369
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesResidConsul" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
           consultorio, r.expedido,(e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona,
           vigencia as id_historia,codcns as nro,nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,
           lower(nempresa) as cadena1,codestaref,nombrecodestared,triaje as id_tipo,seguro as cadena2,
           (u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio}  and r.cod_esta=#{cod_esta} and vigencia=1 and (r.id_estado like #{id_estado}) and 
           fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesResidConsulPerso" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,
           consultorio, r.expedido,(e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona,
           vigencia as id_historia,codcns as nro,nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,
           lower(nempresa) as cadena1,codestaref,nombrecodestared,triaje as id_tipo,seguro as cadena2,
           (u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio} and r.cod_esta=#{cod_esta} and vigencia=1 and r.id_persona=#{id_persona} and 
           (r.id_estado like #{id_estado})  and 
           fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesMedico" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where  r.cod_esta=#{cod_esta} and (r.id_consultorio between #{id_consultorio} and #{id_departamento}) and
           (fecha::timestamp without time zone BETWEEN #{fecha_ini} and #{fecha_fin}) and r.id_estado like #{id_estado} and 
           (vigencia between #{id_historia} and #{id_historial}) and (r.id_persona between #{id_persona} and #{id_localidad})  
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesConsulPublico" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio}  and r.cod_esta=#{cod_esta} and r.id_estado like #{id_estado} and r.cod_esta=#{cod_esta}
     order by r.fecha desc,id_reservacion,nombre limit 100
     <!--cambiado nuevamente esta en Listar reservaciones medico para publico-->
  </select>
  
  <select id="getListarReservacionesConsulMedicoPublico" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio}  and r.cod_esta=#{cod_esta} and r.id_estado like #{id_estado} and r.id_persona=#{id_persona}
     order by r.fecha desc,id_reservacion,nombre limit 50
     <!--cambiado nuevamente esta en Listar reservaciones medico para publico-->
  </select>
  
   <select id="getListarReservacionesConsul" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio} and r.id_persona=#{id_persona} and r.cod_esta=#{cod_esta} and r.cod_esta=#{cod_esta} and 
           (fecha::timestamp without time zone BETWEEN #{fecha_ini} and #{fecha_fin}) 
           and r.id_estado like #{id_estado} and (vigencia between #{id_historia} and #{id_historial}) 
     order by r.fecha,id_reservacion,nombre
     <!--02/08/2016 r.id_persona=#{id_persona}  se ageraga para busqueda de medicos reservaciones personales-->
  </select>
  
  <select id="getListarReservacionesEstadFecha" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio} and r.cod_esta=#{cod_esta} and (fecha::date BETWEEN date(#{fecha_ini})  and date(#{fecha_fin}) )
           and r.id_estado like #{id_estado} and (vigencia between #{id_historia} and #{id_historial})  and r.id_persona=#{id_persona}
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservacionesPersona" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro,id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_consultorio=#{id_consultorio}  and r.cod_esta=#{cod_esta} 
           and (r.id_estado like #{id_estado} or r.id_estado='P') and r.id_persona=#{id_persona} 
     order by r.fecha,id_reservacion,nombre
  </select>
  
  <select id="getListarReservaciones1" resultMap="datoPaciente">
     SELECT hcl,c.id_consultorio,r.fecha::timestamp,edad as edad_ini,id_reservacion,r.id_paciente as id_paciente, p.nombres,consultorio, r.expedido,
            (e.nombres ||' '|| e.paterno ||' '|| e.materno) as nombre, r.id_seguro, r.id_persona, vigencia as id_historia,codcns as nro,
           nro_registro, id_intercon as suma1,carnet,p.telefono,id_empresa,lower(nempresa) as cadena1,codestaref,nombrecodestared,
           triaje as id_tipo,seguro as cadena2,(u.nombres ||' '|| u.paterno ||' '|| u.materno) as cadena3,0 as suma2,0 as suma3,
           0 as suma4, tipoconsult,id_riesgo
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     inner join personas u on id_intercon=u.id_persona
     where r.id_estado like #{id_estado} and r.cod_esta=#{cod_esta} 
     order by r.fecha desc,id_reservacion,nombre
     limit 50
  </select>
  
  <resultMap id="datoPacienteE" type="Historiales">
    <result property="fecha"           column="fecha"/>
    <result property="id_reservacion"    column="id_reservacion"/>
    <result property="nombres"           column="nombres"/>
    <result property="id_paciente"       column="id_paciente"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="fecha"             column="fecha"/>    
    <result property="expedido"          column="expedido"/>        
    <result property="id_cargo"          column="id_cargo"/>
    <result property="id_persona"        column="id_persona"/>
    <result property="carnet"            column="carnet"/>
    <result property="id_consultorio"    column="id_consultorio"/>
    <result property="edad"              column="edad"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="seguro"            column="seguro"/>
    <result property="tipoconsult"       column="tipoconsult"/>
    <result property="id_riesgo"         column="id_riesgo"/>
    <result property="nombre"            column="nombre"/>
  </resultMap>
  
  <select id="getListarCobroReservaUni" resultMap="datoPacienteE">
     SELECT r.fecha,id_reservacion,r.id_paciente, nombres,consultorio,fecha,r.expedido,id_cargo, id_persona,carnet,id_consultorio,
     edad,r.id_seguro,'A' as nombre,tipoconsult,id_riesgo,seguro
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     where r.expedido like #{id_estado} and r.cod_esta=#{cod_esta} and id_reservacion in 
           (select max(id_reservacion) from reservaciones where id_paciente=#{id_paciente} and expedido like #{id_estado}) 
     order by id_reservacion
  </select>
  
  <select id="getListarCobroReserva" resultMap="datoPacienteE">
     SELECT r.fecha,id_reservacion,r.id_paciente, p.nombres,consultorio,r.expedido,id_cargo, e.id_persona,carnet,r.id_consultorio,edad,
     r.id_seguro, (e.nombres||' '||e.paterno||' '||e.materno) as nombre,tipoconsult,id_riesgo,seguro
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where r.id_estado like #{id_estado} and r.cod_esta=#{cod_esta} 
     order by id_reservacion
  </select>
  
  <select id="getListarCobroReservaSignos" resultMap="datoPacienteE">
     SELECT r.fecha,id_reservacion,r.id_paciente, p.nombres,consultorio,fecha,r.expedido,id_cargo, id_persona,carnet,e.id_consultorio,
      edad,r.id_seguro, (e.nombres||' '||e.paterno||' '||e.materno) as nombre,tipoconsult,id_riesgo,seguro
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where r.id_estado like #{id_estado} and (talla=0 or peso=0) and id_intercon=0 and fecha::timestamp>now()- interval '30 hour'
           and r.cod_esta=#{cod_esta} 
     order by r.fecha desc limit 30
  </select>
  
  <select id="getListarReservaSignosCNS" resultMap="datoPacienteE">
     SELECT r.fecha,id_reservacion,r.id_paciente, p.nombres,consultorio,fecha,r.expedido,id_cargo, id_persona,carnet,e.id_consultorio,
      edad,r.id_seguro, (e.nombres||' '||e.paterno||' '||e.materno) as nombre,tipoconsult,id_riesgo,seguro
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where r.id_estado like #{id_estado} and (talla=0 or peso=0) and (r.id_persona between #{id_persona} and #{id_departamento})
           and (r.id_consultorio between #{id_consultorio} and #{id_localidad}) and r.cod_esta=#{cod_esta} 
           and id_intercon=0 and date(fecha)=date(now())
     order by r.fecha desc limit 30
  </select>
 
  <select id="getListarReservaSignosCNS_SC" resultMap="datoPacienteE">
     SELECT r.fecha,id_reservacion,r.id_paciente, p.nombres,consultorio,fecha,r.expedido,id_cargo, id_persona,carnet,e.id_consultorio,
      edad,r.id_seguro, (e.nombres||' '||e.paterno||' '||e.materno) as nombre,tipoconsult,id_riesgo,seguro
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where r.id_estado like #{id_estado} and (talla=0 or peso=0 or temperatura=0) and (r.id_persona between #{id_persona} and #{id_departamento})
           and (r.id_consultorio between #{id_consultorio} and #{id_localidad}) and r.cod_esta=#{cod_esta} 
           and id_intercon=0 and vigencia=1 and fecha::timestamp>now()- interval '7 hour'
     order by r.fecha desc limit 30
  </select>
  
  <select id="getListarReservaSignosCNS_SCUrg" resultMap="datoPacienteE">
     SELECT r.fecha,id_reservacion,r.id_paciente, p.nombres,consultorio,fecha,r.expedido,id_cargo, id_persona,carnet,e.id_consultorio,
      edad,r.id_seguro, (e.nombres||' '||e.paterno||' '||e.materno) as nombre,tipoconsult,id_riesgo,seguro
     FROM reservaciones r 
     JOIN pacientes p USING(id_paciente)
     JOIN consultorios c USING(id_consultorio)
     JOIN personas e USING(id_persona)
     where r.id_estado like #{id_estado} and (talla=0 or peso=0 or temperatura=0) and (r.id_persona between #{id_persona} and #{id_departamento})
           and (r.id_consultorio between #{id_consultorio} and #{id_localidad}) and r.cod_esta=#{cod_esta} 
           and urgencias=1 and id_intercon=0 and vigencia=1 and fecha::timestamp>now()- interval '7 hour'
     order by r.fecha desc limit 30
  </select>
  
  <resultMap id="datosMorbi" type="Historiales">
    <result property="id_historia"       column="id_historia"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="fecha"             column="fecha"/>
    <result property="nombres"           column="nombres"/>        
    <result property="nombre"            column="nombre"/>
    <result property="id_cargo"          column="id_cargo"/>
    <result property="id_persona"        column="id_persona"/>
    <result property="estimc"            column="estimc"/>
  </resultMap>

  <select id="getListaMorbi" resultMap="datosMorbi">
   select id_morbilidad as id_historia,d.id_historial,d.codigo as nombres,literal as nombre,num as id_cargo, 
          tipo as estimc,d.fec_reg as fecha,d.id_persona 
     from detallecie10 d, historiales h, cie10 c
     where d.id_historial=h.id_historial and c.codigo=d.codigo and  h.id_historial=#{id_reservacion} and d.cod_esta=#{cod_esta} 
     order by num
  </select>  
 
  <resultMap id="datosAtendidos" type="Historiales">
    <result property="id_persona"        column="id_persona"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="id_farmacia"       column="id_farmacia"/>
    <result property="fecha"             column="fecha"/>    
    <result property="nombres"           column="nombres"/>        
    <result property="id_paciente"       column="id_paciente"/>
    <result property="expedido"          column="expedido"/>
    <result property="nombre"            column="nombre"/>
    <result property="nombre"            column="nombre"/>
    <result property="accion"            column="accion"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="edad"              column="edad"/>
    <result property="hcl"               column="hcl"/>
    <result property="id_por"            column="id_por"/>
    <result property="id_riesgo"         column="id_riesgo"/>
    <result property="cadena2"           column="cadena2"/>
    <result property="suma1"             column="suma1"/>
    <result property="cod_esta"          column="cod_esta"/>
  </resultMap>

  <select id="getListarAtendidos" resultMap="datosAtendidos">
  (select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,s.seguro as cadena2,id_farmacia,h.id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
     INNER JOIN seguros s on h.id_seguro=s.id_seguro
   where h.id_estado=#{id_estado} and h.cod_esta=#{cod_esta} and h.expedido like #{expedido} and (internado between 0 and 1) and 
         id_historial in (select id_historial from recetas r join historiales h using(id_historial)  
                          where r.id_estado=#{id_estado} and h.expedido like #{expedido} and r.cod_esta=#{cod_esta}  and 
                          (internado between 0 and 1) and id_farmacia= #{id_farmacia} and id_medicamento!=574 group by id_historial ) )
   UNION
   (select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,s.seguro as cadena2,id_farmacia,103 as id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
     INNER JOIN seguros s on h.id_seguro=s.id_seguro
   where h.id_estado=#{id_estado} and h.cod_esta=#{cod_esta} and h.expedido like #{expedido} and (internado between 0 and 1) and 
         id_historial in (select id_historial from recetas r join historiales h using(id_historial)  
                          where r.id_estado=#{id_estado} and h.expedido like #{expedido} and r.cod_esta=#{cod_esta}  and 
                          (internado between 0 and 1) and id_farmacia= #{id_farmacia} and id_medicamento=574 group by id_historial ) )
   order by fecha desc,id_historial,id_riesgo LIMIT 42
  </select> 
  
  <select id="getListarAtendidosCNS" resultMap="datosAtendidos">
   select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,s.seguro as cadena2,id_farmacia,h.id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
     INNER JOIN seguros s on h.id_seguro=s.id_seguro
   where h.id_estado=#{id_estado} and h.cod_esta=#{cod_esta} and h.expedido like #{expedido} and (internado between 0 and 1) and 
         id_historial in (select id_historial from recetas r join historiales h using(id_historial)  
             where r.id_estado=#{id_estado} and h.expedido like #{expedido} and r.cod_esta=#{cod_esta}  and id_farmacia= #{id_farmacia} and
             (internado between 0 and 1) and  date(r.fecha) between current_date-3 and current_date group by id_historial ) 
   order by fecha desc,h.id_historial LIMIT 30
  </select> 
  
  <select id="getListarAtendidosPend" resultMap="datosAtendidos">
   select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,seguro as cadena2,id_farmacia,h.id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
     where h.cod_esta=#{cod_esta} and h.id_estado='A' and id_por=#{id_persona} and id_historial in
     (SELECT id_historial FROM recetas where cod_esta=#{cod_esta} and id_por=#{id_persona} and id_estado='A' and date(fecha)=date(now()))
  </select> 
  
  <select id="getListarAtendidosFarNom" resultMap="datosAtendidos">
  (select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,seguro as cadena2,id_farmacia,103 as id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
   where h.id_estado=#{id_estado} and (internado=0 or internado=1) and h.cod_esta=#{cod_esta} and h.expedido like #{expedido} and id_historial in 
         (select distinct(id_historial) from recetas where cod_esta=#{cod_esta} and id_estado='A' and id_medicamento=574) and
         UPPER(p.nombres||p.carnet||p.nro_registro||p.hcl) like UPPER(#{nombres})  )
   UNION  
   (select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,seguro as cadena2,id_farmacia,0 as id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
   where h.id_estado=#{id_estado} and (internado=0 or internado=1) and h.cod_esta=#{cod_esta} and h.expedido like #{expedido} and id_historial in 
         (select distinct(id_historial) from recetas where cod_esta=#{cod_esta} and id_estado='A' and id_medicamento!=574) and
         UPPER(p.nombres||p.carnet||p.nro_registro||p.hcl) like UPPER(#{nombres})  )
   UNION  
(select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,seguro as cadena2,id_farmacia,h.id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
   where  h.id_estado=#{id_estado} and (internado=0 or internado=1) and h.cod_esta=#{cod_esta} and h.expedido like #{expedido} and id_historial in 
         (select id_historial from recetas where cod_esta=#{cod_esta} and id_estado='A' and UPPER((id_detalle-2700000)||expedido) like UPPER(#{nombres})  ) )      
   order by fecha,id_historial,id_riesgo LIMIT 30
  </select> 
  
  <select id="getListarAtendidosTot" resultMap="datosAtendidos">
   select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,seguro as cadena2,id_farmacia,h.id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
   where h.id_estado=#{id_estado} and h.expedido like #{expedido} and (internado between 0 and 1) and id_historial in (select distinct(id_historial) from recetas where id_estado='A')   
   order by fecha,h.id_historial
  </select> 
  
   <select id="getListarAtendidosEnf" resultMap="datosAtendidos">
   select id_persona,id_historial,fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
      consultorio as accion,h.id_seguro,edad,hcl,h.id_por,seguro as cadena2,id_farmacia,h.id_riesgo, n_rec as suma1,h.cod_esta
   from historiales h
     JOIN pacientes p USING(id_paciente) 
     JOIN consultorios c USING(id_consultorio)
     JOIN personas x USING(id_persona)
   where fecha::timestamp>now()- interval '5 hour' and h.id_estado=#{id_estado} and h.cod_esta=#{cod_esta} and h.expedido like #{expedido} and (internado between 0 and 1) and id_historial in (select distinct(id_historial) from recetas where id_estado='A')   
   order by fecha,h.id_historial 
  </select>  

  <resultMap id="datosAtendidosIN" type="Historiales">
    <result property="id_persona"        column="id_persona"/>
    <result property="id_historia"       column="id_historia"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="fecha"             column="fecha"/>    
    <result property="nombres"           column="nombres"/>        
    <result property="id_paciente"       column="id_paciente"/>
    <result property="expedido"          column="expedido"/>
    <result property="nombre"            column="nombre"/>
    <result property="accion"            column="accion"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="edad"              column="edad"/>
    <result property="hcl"               column="hcl"/>
    <result property="id_por"            column="id_por"/>
    <result property="id_riesgo"         column="id_riesgo"/>
    <result property="cadena2"           column="cadena2"/>
    <result property="suma1"             column="suma1"/>
    <result property="cod_esta"          column="cod_esta"/>
  </resultMap>
  
 <select id="getListarAtendidosI" resultMap="datosAtendidosIN">
   select i.id_persona,id_historia,id_historial,i.fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
        consultorio as accion,h.id_seguro,h.edad,hcl,i.id_por,p.seguro as cadena2,h.id_riesgo, n_rec as suma1,h.cod_esta
     from historiainter i
       JOIN consultorios c USING(id_consultorio)
       join personas x using(id_persona)
       join historiales h using(id_historial)
       join pacientes p using(id_paciente)
     where internado >1 and h.expedido like #{expedido} and id_historia in 
           (select id_historia from recetas where id_historia>0 and id_estado=#{id_estado} and cod_esta=#{cod_esta} and id_farmacia= #{id_farmacia}) 
     Order by i.fecha desc,p.nombres LIMIT 31 
  </select> 
  
  <select id="getListarAtendidosICNS" resultMap="datosAtendidosIN">
     select i.id_persona,id_historia,id_historial,i.fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
        consultorio as accion,h.id_seguro,h.edad,hcl,i.id_por,p.seguro as cadena2,h.id_riesgo, n_rec as suma1,h.cod_esta
     from historiainter i
       JOIN consultorios c USING(id_consultorio)
       join personas x using(id_persona)
       join historiales h using(id_historial)
       join pacientes p using(id_paciente)
     where internado >1 and h.expedido like #{expedido} and id_historia in 
           (select id_historia from recetas where id_historia>0 and id_estado=#{id_estado} and cod_esta=#{cod_esta} and 
            id_farmacia= #{id_farmacia}  )  <!--and date(fecha) between current_date-3 and current_date -->
     Order by i.fecha desc,p.nombres limit 31
  </select> 
  
  <select id="getListarAtendidosIFarNom" resultMap="datosAtendidosIN">
    (select i.id_persona,id_historia,id_historial,i.fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
        consultorio as accion,h.id_seguro,h.edad,hcl,i.id_por,p.seguro as cadena2,h.id_riesgo, n_rec as suma1,h.cod_esta
     from historiainter i
       JOIN consultorios c USING(id_consultorio)
       join personas x using(id_persona)
       join historiales h using(id_historial)
       join pacientes p using(id_paciente)
     where internado >1 and h.expedido like #{expedido} and id_historia in 
           (select id_historia from recetas where id_historia>0 and id_estado=#{id_estado} and cod_esta=#{cod_esta}) and
         UPPER(p.nombres) like UPPER(#{nombres}) ) 
      UNION    
      (select i.id_persona,id_historia,id_historial,i.fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
        consultorio as accion,h.id_seguro,h.edad,hcl,i.id_por,p.seguro as cadena2,h.id_riesgo, n_rec as suma1,h.cod_esta
     from historiainter i
       JOIN consultorios c USING(id_consultorio)
       join personas x using(id_persona)
       join historiales h using(id_historial)
       join pacientes p using(id_paciente)
     where internado >1 and h.expedido like #{expedido} and id_historia in 
           (select id_historia from recetas where id_historia>0  and id_estado=#{id_estado} and cod_esta=#{cod_esta}) and
         UPPER(expedido) like UPPER(#{nombres}) ) 
     Order by fecha,nombres LIMIT 50  
  </select> 
  
  <select id="getListarAtendidosITot" resultMap="datosAtendidosIN">
     select i.id_persona,id_historia,id_historial,i.fecha, p.nombres, h.id_paciente, h.expedido,(x.nombres ||' '|| x.paterno ||' '|| x.materno) as nombre,
        consultorio as accion,h.id_seguro,h.edad,hcl,i.id_por,p.seguro as cadena2,h.id_riesgo, n_rec as suma1,h.cod_esta
     from historiainter i
       JOIN consultorios c USING(id_consultorio)
       join personas x using(id_persona)
       join historiales h using(id_historial)
       join pacientes p using(id_paciente)
     where internado >1 and h.expedido like #{expedido} and i.id_estado=#{id_estado} 
     Order by i.fecha,p.nombres  LIMIT 50
  </select> 

  <resultMap id="datoHistoriaGen" type="Historiales">
    <result property="id_persona"        column="id_persona"/>
    <result property="hcl"               column="hcl"/>
    <result property="id_paciente"       column="id_paciente"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="fecha"             column="fecha"/>          
    <result property="nombre"            column="nombre"/>
    <result property="nombres"           column="nombres"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="fechalab"          column="fechalab"/>
    <result property="embarazo"          column="embarazo"/>
    <result property="expedido"          column="expedido"/>
    <result property="diagnostico"       column="diagnostico"/>
    <result property="codigo"            column="codigo"/>
    <result property="accion"            column="accion"/>    
    <result property="codigo"            column="codigo"/>  
    <result property="accion"            column="accion"/>
    <result property="edad"              column="edad"/>
    <result property="mes"               column="mes"/>
    <result property="dia"               column="dia"/>
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>
    <result property="id_riesgo"         column="id_riesgo"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="cadena2"           column="cadena2"/>
    <result property="cod_esta"          column="cod_esta"/>
  </resultMap>
  
  <select id="getListarHistoriaGen" resultMap="datoHistoriaGen"> 
   select h.id_persona,hcl, h.id_paciente, h.id_historial, h.fecha,(e.paterno||' ' ||e.materno||' ' ||e.nombres)::varchar as nombre,p.nombres, 
     consultorio, p.fec_nacimiento as fechalab, embarazo, h.expedido,diagnostico,h.codigo,accion,edad,
     extract(month from age(h.fecha,p.fec_nacimiento))::int  as mes,
     extract(day from age(h.fecha,p.fec_nacimiento))::int  as dia,talla,peso, h.id_seguro,p.seguro as cadena2,
     h.id_riesgo,h.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas e USING(id_persona)
       JOIN pacientes p USING(id_paciente)
   where (fecha::date BETWEEN #{fecha_ini}  and #{fecha_fin}) and h.cod_esta=#{cod_esta} 
   order by h.fecha,h.id_persona, h.id_historial
  </select>
  
  <select id="getListarHistoriaMicro" resultMap="datoHistoriaGen"> 
   select h.id_persona,hcl, h.id_paciente, h.id_historial, h.fecha,(e.paterno||' ' ||e.materno||' ' ||e.nombres)::varchar as nombre,p.nombres, 
     consultorio, p.fec_nacimiento as fechalab, embarazo, h.expedido,diagnostico,h.codigo,accion,edad,
     extract(month from age(h.fecha,p.fec_nacimiento))::int  as mes,
     extract(day from age(h.fecha,p.fec_nacimiento))::int  as dia,talla,peso, h.id_seguro,p.seguro as cadena2,
     h.id_riesgo,h.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas e USING(id_persona)
       JOIN pacientes p USING(id_paciente)
   where h.cod_esta=#{cod_esta} and id_historial in (select id_historial from recetas where id_medicamento=#{id_cargo} and 
                          fecha::date between #{fecha_ini}  and #{fecha_fin} and cod_esta=#{cod_esta})   
   order by h.fecha,h.id_persona, h.id_historial
  </select>
  
   <resultMap id="datoPrestacion"    type="Historiales">
    <result property="registro"              column="registro"/>
    <result property="fecha"                 column="fecha"/>
    <result property="nombre"                column="nombre"/>    
    <result property="diagnostico"           column="diagnostico"/>
    <result property="codigo"                column="codigo"/> 
    <result property="edad"                  column="edad"/> 
    <result property="mes"                   column="mes"/>
    <result property="dia"                   column="dia"/>
    <result property="accion"                column="accion"/>
    <result property="repetida"              column="repetida"/> 
    <result property="rango"                 column="rango"/>
    <result property="nombres"               column="nombres"/>
    <result property="num"                   column="num"/>
  </resultMap>
  
   <select id="getListarResumenPrestacion" resultMap="datoPrestacion">
     select nro_registro as registro,r.fecha, (m.nombres ||' '|| m.paterno ||' '|| m.materno) as nombre,
     extract(year from age( historiales.fecha,p.fec_nacimiento))::int  as edad,
     extract(month from age( historiales.fecha,p.fec_nacimiento))::int  as mes,
     extract(day from age( historiales.fecha,p.fec_nacimiento))::int  as dia,
     (CASE WHEN p.id_tipo_sexo=1 THEN 'F' ELSE 'M' END) as accion,
     repetida, substring(descripcion,1,30) as diagnostico,prestacion as codigo, costo as rango, p.nombres,cantidad as num
        from recetass r
        join personas m using(id_persona)
        join historiales using(id_historial)
        join pacientes p using(id_paciente)
        join prestacion using(id_prestacion)
        where (r.fecha::date BETWEEN #{fecha_ini} and #{fecha_fin}) 
        order by fecha,nombres,codigo
  </select> 
  
  <select id="getListarResumenPrestacion2" resultMap="datoPrestacion">
     select nro_registro as registro,r.fecha, (m.nombres ||' '|| m.paterno ||' '|| m.materno) as nombre,
     extract(year from age( historiales.fecha,p.fec_nacimiento))::int  as edad,
     extract(month from age( historiales.fecha,p.fec_nacimiento))::int  as mes,
     extract(day from age( historiales.fecha,p.fec_nacimiento))::int  as dia,
     (CASE WHEN p.id_tipo_sexo=1 THEN 'F' ELSE 'M' END) as accion,
     repetida, substring(descripcion,1,30) as diagnostico,prestacion as codigo, costo as rango, p.nombres,cantidad as num
        from recetass r
        join personas m using(id_persona)
        join historiales using(id_historial)
        join pacientes p using(id_paciente)
        join prestacion using(id_prestacion)
        where (prestacion='O80' or prestacion='Z381' or prestacion='O00' or prestacion='PC120' or prestacion='O820' or prestacion='O410' or 
	   prestacion='O84' or prestacion='PC122' or prestacion='PC123' or prestacion='PC124' or 
	   prestacion='PC125' or prestacion='O63' or prestacion='O64' or prestacion='O65' or 
	   prestacion='O68' or prestacion='O69') and (r.fecha::date BETWEEN #{fecha_ini} and #{fecha_fin}) 
        order by diagnostico,fecha,nombres,codigo
  </select> 
  
   <select id="getListarPrestacionYa" resultMap="datoPrestacion">
     select nro_registro as registro,r.fecha, (m.nombres ||' '|| m.paterno ||' '|| m.materno) as nombre,
     extract(year from age( historiales.fecha,p.fec_nacimiento))::int  as edad,
     extract(month from age( historiales.fecha,p.fec_nacimiento))::int  as mes,
     extract(day from age( historiales.fecha,p.fec_nacimiento))::int  as dia,
     (CASE WHEN p.id_tipo_sexo=1 THEN 'F' ELSE 'M' END) as accion,
     repetida, substring(descripcion,1,30) as diagnostico,prestacion as codigo, r.id_persona as rango, p.nombres,cantidad as num
        from recetass r
        join personas m using(id_persona)
        join historiales using(id_historial)
        join pacientes p using(id_paciente)
        join prestacion using(id_prestacion)
        where r.id_prestacion=#{id_provincia} and r.id_historial=#{id_historial} and r.cod_esta=#{cod_esta} 
        order by diagnostico,fecha,nombres,codigo
  </select> 
  
  <resultMap id="datoHistoriaInter" type="Historiales">
    <result property="id_paciente"       column="id_paciente"/>
    <result property="id_historia"       column="id_historia"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="id_persona"        column="id_persona"/>
    <result property="id_consultorio"    column="id_consultorio"/>
    <result property="fecha"             column="fecha"/>          
    <result property="consultorio"       column="consultorio"/>
    <result property="nombres"           column="nombres"/>
    <result property="diagnostico"       column="diagnostico"/>
    <result property="piso"              column="piso"/>
    <result property="id_sala"           column="id_sala"/>
    <result property="id_cama"           column="id_cama"/>
    <result property="id_piso"           column="id_piso"/>
    <result property="codigo"            column="codigo"/>
    <result property="accion"            column="accion"/>
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>
    <result property="fr"                column="fr"/>
    <result property="id_sexo"           column="id_sexo"/>
  </resultMap>
  
  <select id="getHistoriaInter" resultMap="datoHistoriaInter"> 
    (select id_historia,id_historial, id_persona, h.id_consultorio, fecha, consultorio,(paterno||' ' ||materno||' ' ||nombres)::varchar as nombres,
        diagnostico,h.sala as id_sala,h.cama as id_cama,h.id_piso,s.sala as codigo,m.cama as accion,talla,peso,temperatura,fc,pa,fr,0 as id_paciente,
        0 as id_sexo,'P'::text as piso
       from historiainter h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       join salas s on s.id_sala=h.sala
       join camas m on m.id_cama=h.cama
     where id_historial=#{id_historial} and char_length(diagnostico)>1 and h.id_persona in 
     (select id_persona from personas where id_consultorio in (select id_consultorio from consultorios where id_cargo>17)) )
   UNION
   (select id_historia,id_historial, id_persona, h.id_consultorio, fecha, consultorio,(paterno||' ' ||materno||' ' ||nombres)::varchar as nombres,
        diagnostico,h.sala as id_sala,h.cama as id_cama,h.id_piso,s.sala as codigo,m.cama as accion,talla,peso,temperatura,fc,pa,fr,0 as id_paciente,
        0 as id_sexo,'P'::text as piso
       from historiainter h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       join salas s on s.id_sala=h.sala
       join camas m on m.id_cama=h.cama
     where id_historia= (select max(id_historia) from historiainter where id_historial=#{id_historial}) and h.id_persona in 
     (select id_persona from personas where id_consultorio in (select id_consultorio from consultorios where id_cargo>17)) )
     order by fecha,id_historia 
     <!--mo cambiar el ordenado (order by) de esta manera para que muestre la ultima receta de internado-->
  </select> 
  
   <select id="getHistoriaInterMedico" resultMap="datoHistoriaInter"> 
      select id_historia,id_historial, h.id_persona, h.id_consultorio, h.fecha, consultorio,(paterno||' ' ||materno||' ' ||nombres)::varchar as nombres,
        h.diagnostico,h.sala as id_sala,h.cama as id_cama,h.id_piso,s.sala as codigo,m.cama as accion,h.talla,h.peso,h.temperatura,h.fc,h.pa,h.fr,id_paciente,
        h.id_piso as id_sexo,piso
       from historiainter h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN historiales i USING(id_historial)
       join salas s on s.id_sala=h.sala
       join camas m on m.id_cama=h.cama
       join pisos pp on pp.id_piso=h.id_piso
     where id_historial=#{id_historial} and h.cod_esta=#{cod_esta} and char_length(h.diagnostico)>1 and h.id_persona in 
     (select id_persona from personas where id_consultorio!=6 and id_consultorio!=7 and id_consultorio!=8) 
     order by h.fecha desc  limit 10
  </select> 
  
  <select id="getHistoriaInterMedicoReceta" resultMap="datoHistoriaInter"> 
      select id_historia,id_historial, h.id_persona, h.id_consultorio, h.fecha, consultorio,(paterno||' ' ||materno||' ' ||nombres)::varchar as nombres,
        h.diagnostico,h.sala as id_sala,h.cama as id_cama,h.id_piso,s.sala as codigo,m.cama as accion,h.talla,h.peso,h.temperatura,h.fc,h.pa,h.fr,id_paciente,
        h.id_piso as id_sexo,piso
       from historiainter h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN historiales i USING(id_historial)
       join salas s on s.id_sala=h.sala
       join camas m on m.id_cama=h.cama
       join pisos pp on pp.id_piso=h.id_piso
     where id_historial=#{id_historial} and id_historia=#{id_historia} and h.cod_esta=#{cod_esta} 
     order by h.fecha desc  limit 1
  </select> 
  
   <select id="getHistoriaInterEnfer" resultMap="datoHistoriaInter"> 
      Select id_historia,id_historial, h.id_persona, h.id_consultorio, h.fecha, consultorio,(paterno||' ' ||materno||' ' ||nombres)::varchar as nombres,
        h.diagnostico,h.sala as id_sala,h.cama as id_cama,h.id_piso,s.sala as codigo,m.cama as accion,h.talla,h.peso,h.temperatura,h.fc,h.pa,h.fr,id_paciente,
        h.id_piso as id_sexo,piso
       from historiainter h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN historiales i USING(id_historial)
       join salas s on s.id_sala=h.sala
       join camas m on m.id_cama=h.cama
       join pisos pp on pp.id_piso=h.id_piso
     where id_historial=#{id_historial} and h.cod_esta=#{cod_esta} and char_length(h.diagnostico)>2 and h.id_persona in 
     (select id_persona from personas where id_consultorio=6 or id_consultorio=8) 
     order by h.fecha desc limit 10
  </select> 
  
  <resultMap id="datoHistorial" type="Historiales">
    <result property="id_paciente"       column="id_paciente"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="hcl"               column="hcl"/>
    <result property="fecha"             column="fecha"/>          
    <result property="nombres"           column="nombres"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="diagnostico"       column="diagnostico"/>
    <result property="subjetivo"         column="subjetivo"/>
    <result property="objetivo"          column="objetivo"/>    
    <result property="codigo"            column="codigo"/>  
    <result property="accion"            column="accion"/>
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>
    <result property="edad"              column="edad"/>
    <result property="mes"               column="mes"/>
    <result property="dia"               column="dia"/>
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>
    <result property="fr"                column="fr"/>
    <result property="estimc"            column="estimc"/>
    <result property="expedido"          column="expedido"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="id_persona"        column="id_persona"/>
    <result property="internado"         column="internado"/>
    <result property="embarazo"          column="embarazo"/>
    <result property="cama"              column="cama"/>
    <result property="nombre"            column="nombre"/>
    <result property="registro"          column="registro"/>
    <result property="seguro"            column="seguro"/>
    <result property="fechalab"          column="fechalab"/>    
    <result property="tipoconsult"       column="tipoconsult"/>
    <result property="id_riesgo"         column="id_riesgo"/>
    <result property="cod_esta"          column="cod_esta"/>
   </resultMap>
  
  <select id="getListarHistoria" resultMap="datoHistorial"> 
     select h.id_paciente,id_historial,a.hcl,h.fecha, (p.paterno||' ' ||p.materno||' ' ||p.nombres)::varchar as nombres,consultorio,diagnostico,subjetivo,
        objetivo,cie10.codigo||' '||literal as codigo,accion, talla, peso, h.id_estado, edad,
        (CASE WHEN (fechavig is null or fechavig>h.fecha) THEN h.fecha::timestamp without time zone ELSE fechavig::timestamp without time zone END)  as fechalab,
        extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido, h.id_seguro,h.id_persona,embaraza as embarazo,
        (CASE WHEN (internado=2 or internado=6 or internado=7 or internado=8 or internado=13 or internado=14 or internado=5 or internado=4) THEN 2 ELSE internado END) as internado,
        establecimiento as cama,a.nombres as nombre,registro,seguro,tipoconsult,id_riesgo,h.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN pacientes a USING(id_paciente)
       join cie10 ON cie10.codigo = h.codigo 
       join establecimientos ON establecimientos.cod_esta = h.cod_esta   
     where  id_paciente=#{id_paciente} and h.cod_esta=#{cod_esta} 
     order by fecha desc,-h.id_historial  <!--diagnostico!='Desde Farmacia' and -->
  </select> 
  
  <select id="getListarHistoriaTodo" resultMap="datoHistorial"> 
     select h.id_paciente,id_historial,a.hcl,h.fecha, (p.paterno||' ' ||p.materno||' ' ||p.nombres)::varchar as nombres,consultorio,diagnostico,subjetivo,
        objetivo,cie10.codigo||' '||literal as codigo,accion, talla, peso, h.id_estado, edad,
         (CASE WHEN (fechavig is null or fechavig>h.fecha) THEN h.fecha::timestamp without time zone ELSE fechavig::timestamp without time zone END)  as fechalab,
        extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido, h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        establecimiento as cama,a.nombres as nombre,registro,seguro,tipoconsult,id_riesgo,h.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN pacientes a USING(id_paciente)
       join cie10 ON cie10.codigo = h.codigo 
       join establecimientos ON establecimientos.cod_esta = h.cod_esta   
     where id_paciente=#{id_paciente} 
     order by fecha desc,-h.id_historial <!--diagnostico!='Desde Farmacia' and -->
  </select> 
  
  <resultMap id="datoHistoria" type="Historiales">
    <result property="id_paciente"      column="id_paciente"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="id_historia"       column="id_historia"/>
    <result property="hcl"               column="hcl"/>
    <result property="fecha"             column="fecha"/>          
    <result property="nombres"           column="nombres"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="diagnostico"       column="diagnostico"/>
    <result property="subjetivo"         column="subjetivo"/>
    <result property="objetivo"          column="objetivo"/>    
    <result property="codigo"            column="codigo"/>  
    <result property="accion"            column="accion"/>
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>
    <result property="edad"              column="edad"/>
    <result property="mes"               column="mes"/>
    <result property="dia"               column="dia"/>
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>
    <result property="fr"                column="fr"/>
    <result property="estimc"            column="estimc"/>
    <result property="expedido"          column="expedido"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="id_persona"        column="id_persona"/>
    <result property="internado"         column="internado"/>
    <result property="embarazo"          column="embarazo"/>
    <result property="cama"              column="cama"/>
    <result property="nombre"            column="nombre"/>
    <result property="id_por"            column="id_por"/>
    <result property="id_carpeta"        column="id_carpeta"/>
    <result property="tipoconsult"      column="tipoconsult"/>
    <result property="id_riesgo"         column="id_riesgo"/>
    <result property="cod_esta"          column="cod_esta"/>
   </resultMap>

  <select id="getListarHistoriaMed" resultMap="datoHistoria"> 
     select id_paciente,0 as id_historia, id_historial,a.hcl,h.fecha, (p.paterno||' ' ||p.materno||' ' ||p.nombres)::varchar as nombres,consultorio,diagnostico,subjetivo,
        objetivo,cie10.codigo||' '||literal as codigo,accion, talla, peso, h.id_estado, edad,
        extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido, h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        establecimiento as cama,a.nombres as nombre,0 as id_por,0 as id_carpeta,tipoconsult,id_riesgo,h.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN pacientes a USING(id_paciente)
       join cie10 ON cie10.codigo = h.codigo 
       join establecimientos ON establecimientos.cod_esta = h.cod_esta   
     where h.id_persona=#{id_persona} and (h.fecha::date BETWEEN #{fecha_ini} and #{fecha_fin}) 
     order by fecha,h.id_historial
  </select> 
  
  <select id="getListarHistoriaHoy" resultMap="datoHistoria"> 
     select 0 as id_paciente,0 as id_historia,id_historial, 0 as hcl,fecha, (paterno||' ' ||materno||' ' ||nombres)::varchar as nombres,consultorio,diagnostico,subjetivo,
        objetivo,'0' as codigo,accion, talla, peso, h.id_estado, edad,
        extract(month from age( fecha,fec_nacimiento))::int as mes,extract(day from age( fecha,fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido , h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        '' as cama,'A' as nombre,0 as id_por,0 as id_carpeta,tipoconsult,id_riesgo,h.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
     where id_paciente=#{id_paciente} and id_historial=#{id_historial} and h.cod_esta=#{cod_esta}  
           <!--fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')-->
     order by fecha,h.id_historial
  </select>
  
  <select id="getListarHistoriaInterHoy" resultMap="datoHistoria"> 
     select id_paciente,id_historia,id_historial,a.hcl,h.fecha, expedido as nombres,h.id_consultorio as consultorio,i.diagnostico,subjetivo,objetivo,
           expedido as codigo, accion, h.talla, h.peso, h.id_estado, edad,
           extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        h.temperatura,h.fc,h.pa,h.fr,'0' as estimc, expedido , h.id_seguro,i.id_persona,internado,embaraza as embarazo,
        '' as cama,a.nombres as nombre, h.id_por,i.id_consultorio as id_carpeta,tipoconsult,id_riesgo,h.cod_esta    
     from historiales h
       JOIN historiainter i USING(id_historial)
       JOIN pacientes a USING(id_paciente)
       where id_paciente=#{id_paciente} and extract(year from (i.fecha))=extract(year from now()) and
       extract(month from (i.fecha))=extract(month from now()) and extract(day from (i.fecha))=extract(day from now()) 
       limit 1
  </select>
  
  <select id="getUltHistoriaInter" resultMap="datoHistoria"> 
      select id_paciente,id_historia,id_historial,a.hcl,i.fecha, expedido as nombres,h.id_consultorio as consultorio,i.diagnostico,subjetivo,objetivo,
           expedido as codigo, accion, i.talla, i.peso, h.id_estado, edad,
           extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        i.temperatura,i.fc,i.pa,i.fr,'0' as estimc, expedido , h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        '' as cama,a.nombres as nombre,0 as id_por,i.id_consultorio as id_carpeta,tipoconsult,id_riesgo,h.cod_esta  
     from historiales h
       JOIN historiainter i USING(id_historial)
       JOIN pacientes a USING(id_paciente)
       where id_historia in 
       (select max(id_historia) from historiainter 
         where  id_historial=#{id_historial} and cod_esta=#{cod_esta} and octet_length(diagnostico)>3) 
         <!--id_consultorio=#{id_consultorio} and se borra 25/01/2017 no repite de varios-->
  </select>
  
  <select id="getHistoriaInterIndi" resultMap="datoHistoria"> 
      select id_paciente,id_historia , id_historial,a.hcl,i.fecha, expedido as nombres,h.id_consultorio as consultorio,i.diagnostico,subjetivo,objetivo,
           expedido as codigo, accion, i.talla, i.peso, h.id_estado, edad,
           extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        i.temperatura,i.fc,i.pa,i.fr,'0' as estimc, expedido , h.id_seguro,i.id_persona,internado,embaraza as embarazo,
        '' as cama,a.nombres as nombre,i.id_por,i.id_consultorio as id_carpeta,tipoconsult,id_riesgo,h.cod_esta  
     from historiales h
       JOIN historiainter i USING(id_historial)
       JOIN pacientes a USING(id_paciente)
       where id_historia =#{id_historia} and h.cod_esta=#{cod_esta} 
  </select>
 
  <select id="getListarHistoriaI" resultMap="datoHistoria"> 
   select 0 as id_paciente,0 as id_historia,id_historial,0 as hcl,fecha, (paterno||' ' ||materno||' ' ||nombres)::varchar as nombres,consultorio,diagnostico,subjetivo,
     objetivo,0 as codigo,accion, talla, peso, h.id_estado, edad,
     extract(month from age( fecha,fec_nacimiento))::int as mes,extract(day from age( fecha,fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido , h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        '' as cama,p.nombres as nombre,0 as id_por,0 as id_carpeta,tipoconsult,id_riesgo,h.cod_esta  
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
     where id_paciente=#{id_paciente} and internado=2 and h.cod_esta=#{cod_esta} 
  </select>  
  
  <select id="setRegistrarHistorial" resultType="Integer">
    SELECT registrar_historial(#{id_historial}, #{id_paciente}, #{id_consultorio}, #{id_persona}, #{repetida}, 
           #{diagnostico}, #{subjetivo}, #{objetivo}, #{edad}, #{rango}, #{talla}, #{peso}, #{temperatura}, #{fc}, 
           #{pa}, #{fr}, #{so2}, #{glicemia},#{expedido},#{codigo},#{accion},#{registro},#{id_seguro},#{vigencia},#{id_por},
           #{fechalab},#{triaje},#{tipoconsult},#{id_riesgo},#{cod_esta}) ;
      
    UPDATE pacientes 
     SET veces=1+(select count(*) as num from historiales where id_paciente=#{id_paciente} and octet_length(codigo)>2)
     WHERE id_paciente=#{id_paciente};  
  </select> 
  
  <update id="setModificarSignosReserva">
    update reservaciones
    set  talla=#{talla}, peso=#{peso}, temperatura=#{temperatura}, fc=#{fc}, pa=#{pa}, fr=#{fr}, so2=#{so2}, glicemia=#{glicemia}       
    where id_reservacion = #{id_historial} and cod_esta=#{cod_esta} 
  </update>
  
  <update id="setModificarEstadoHistoria">
    update historiales
       set  id_estado = #{id_estado}       
       where id_historial = #{id_historial} 
  </update>

  <update id="setModificarRangoHistoria" >
    update historiales
       set  rango = #{rango}       
       where id_historial = #{id_historial}
  </update>

  <resultMap id="datosHistorial" type="Historiales">
    <result property="id_historial"      column="id_historial"/>  
    <result property="id_persona"        column="id_persona"/>  
    <result property="nombre"            column="nombre"/>  
    <result property="id_consultorio"    column="id_consultorio"/>  
    <result property="fecha"             column="fecha"/>         
    <result property="repetida"          column="repetida"/>   
    <result property="diagnostico"       column="diagnostico"/>
    <result property="subjetivo"         column="subjetivo"/>
    <result property="objetivo"          column="objetivo"/> 
    <result property="id_sexo"           column="id_sexo"/>   
    <result property="edad"              column="edad"/>   
    <result property="mes"               column="mes"/>   
    <result property="dia"               column="dia"/>   
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>    
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>    
    <result property="fr"                column="fr"/>    
    <result property="so2"               column="so2"/>    
    <result property="glicemia"          column="glicemia"/>    
    <result property="expedido"          column="expedido"/>    
    <result property="registro"          column="registro"/> 
    <result property="id_persona"        column="id_persona"/>            
    <result property="id_paciente"       column="id_paciente"/>            
    <result property="id_consultorio"    column="id_consultorio"/> 
    <result property="codigo"            column="codigo"/>
    <result property="rango"             column="rango"/>
    <result property="accion"            column="accion"/>
    <result property="id_estado"         column="id_estado"/>
    <result property="id_cargo"          column="id_cargo"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="cod_esta"          column="cod_esta"/>
    <result property="triaje"            column="triaje"/>    
    <result property="id_por"            column="id_por"/>
    <result property="fechalab"          column="fechalab"/>
    <result property="tipoconsult"       column="tipoconsult"/>
    <result property="id_riesgo"         column="id_riesgo"/>
  </resultMap>

   <select id="getDatosHistorial" resultMap="datosHistorial">  
     SELECT  (SELECT paterno || ' ' || materno || ' ' || nombres AS Expr1 FROM personas WHERE (id_persona = a.id_persona)) AS nombre,
     id_historial,id_persona,id_consultorio,fecha,repetida , diagnostico , subjetivo , objetivo, id_tipo_sexo as id_sexo, edad, 
     extract(month from age( fecha,fec_nacimiento))::int as mes, extract(day from age( fecha,fec_nacimiento))::int as dia,
     talla,peso, temperatura, fc, pa, fr,so2,glicemia, expedido, id_persona,id_paciente,id_consultorio,codigo,rango,
     accion, a.id_estado,internado as id_cargo,registro, a.id_seguro,a.cod_esta,id_por,triaje,fechavig as fechalab,
     tipoconsult,id_riesgo
     from historiales  a
     join pacientes using(id_paciente)
     where id_historial = #{id_historial} order by id_historial desc limit 1
   </select>   
   
   <resultMap id="datosHistorialEmer" type="Historiales">
    <result property="id_historia"      column="id_historia"/>  
    <result property="id_historial"      column="id_historial"/>  
    <result property="id_persona"        column="id_persona"/>  
    <result property="id_consultorio"    column="id_consultorio"/>  
    <result property="fecha"             column="fecha"/>         
    <result property="repetida"          column="repetida"/>   
    <result property="diagnostico"       column="diagnostico"/>
    <result property="subjetivo"         column="subjetivo"/>
    <result property="objetivo"          column="objetivo"/> 
    <result property="id_sexo"           column="id_sexo"/>   
    <result property="edad"              column="edad"/>   
    <result property="mes"               column="mes"/>   
    <result property="dia"               column="dia"/>   
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>    
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>    
    <result property="fr"                column="fr"/>        
    <result property="expedido"          column="expedido"/>            
    <result property="id_persona"        column="id_persona"/>            
    <result property="id_paciente"       column="id_paciente"/>            
    <result property="id_consultorio"    column="id_consultorio"/> 
    <result property="codigo"            column="codigo"/>
    <result property="rango"             column="rango"/>
    <result property="accion"            column="accion"/>
    <result property="id_estado"         column="id_estado"/>
    <result property="id_cargo"          column="id_cargo"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="cod_esta"          column="cod_esta"/>
    <result property="registro"          column="registro"/>
    <result property="estimc"            column="estimc"/>
    <result property="nit"               column="nit"/>
    <result property="cadena1"           column="cadena1"/>
    <result property="cadena2"           column="cadena2"/>
    <result property="cadena3"           column="cadena3"/>
    <result property="cadena4"           column="cadena4"/>
    <result property="cadena5"           column="cadena5"/>
    <result property="cadena6"           column="cadena6"/>
    <result property="cadena7"           column="cadena7"/>
    <result property="cadena8"           column="cadena8"/>
    <result property="cadena9"           column="cadena9"/>
    <result property="cadena10"           column="cadena10"/>
    <result property="cadena11"           column="cadena11"/>
    <result property="cadena12"           column="cadena12"/>
    <result property="cadena13"           column="cadena13"/>
    <result property="cadena14"           column="cadena14"/>
    <result property="cadena15"           column="cadena15"/>
    <result property="cadena20"           column="cadena20"/>
    <result property="cadena21"           column="cadena21"/>
    <result property="cod_esta"           column="cod_esta"/>
  </resultMap>

   <select id="getDatosEmergencia" resultMap="datosHistorialEmer">  
     SELECT  id_historia,id_historial,e.id_persona,e.id_consultorio,e.fecha,repetida , diagnostico , subjetivo , objetivo, id_tipo_sexo as id_sexo, edad, 
     extract(month from age( e.fecha,fec_nacimiento))::int as mes, extract(day from age( e.fecha,fec_nacimiento))::int as dia,
     talla,peso, temperatura, expedido, e.id_persona,id_paciente,e.id_consultorio,codigo,rango,
     accion, a.id_estado,internado as id_cargo, a.id_seguro,a.cod_esta, antpato as cadena13,antfami as cadena14, antgineco as pa,
     histoemfer as fc,evolucion as registro, conducta as estimc, condicion as fr, observacion as nit, introduccion as cadena1,
     ant_nopato as cadena2,fisico_cabeza as cadena3,fisico_cara as cadena4,fisico_cuello as cadena5,fisico_torax as cadena6,
     fisico_corazon as cadena7,fisico_pulmon as cadena8,fisico_abdomen as cadena9,fisico_extrem as cadena10,observacion as cadena15,
     fisico_genito as cadena11,fisico_neuro as cadena12,id_tipo,he_accion as cadena20,he_diagnostico as cadena21,e.cod_esta
     from historiales  a
     join historiaemerg e using(id_historial)
     join pacientes using(id_paciente)
     where id_historia = #{id_historia}  and e.cod_esta=#{cod_esta} 
     order by fecha desc limit 1
     <!-- 31/05/2016 se quita id_tipo = #{id_tipo} and id_historial = #{id_historial} para sacar cualquier nota y modificarla -->
   </select>  
   
   <select id="getDatosEmergenciaSolo" resultMap="datosHistorialEmer">  
     SELECT  id_historia,id_historial,e.id_persona,e.id_consultorio,e.fecha,repetida , diagnostico , subjetivo , objetivo, id_tipo_sexo as id_sexo, edad, 
     extract(month from age( e.fecha,fec_nacimiento))::int as mes, extract(day from age( e.fecha,fec_nacimiento))::int as dia,
     talla,peso, temperatura, expedido, e.id_persona,id_paciente,e.id_consultorio,codigo,rango,
     accion, a.id_estado,internado as id_cargo, a.id_seguro,a.cod_esta, antpato as cadena13,antfami as cadena14, antgineco as pa,
     histoemfer as fc,evolucion as registro, conducta as estimc, condicion as fr, observacion as nit, introduccion as cadena1,
     ant_nopato as cadena2,fisico_cabeza as cadena3,fisico_cara as cadena4,fisico_cuello as cadena5,fisico_torax as cadena6,
     fisico_corazon as cadena7,fisico_pulmon as cadena8,fisico_abdomen as cadena9,fisico_extrem as cadena10,observacion as cadena15,
     fisico_genito as cadena11,fisico_neuro as cadena12,id_tipo,he_accion as cadena20,he_diagnostico as cadena21,e.cod_esta
     from historiales  a
     join historiaemerg e using(id_historial)
     join pacientes using(id_paciente)
     where id_historia = #{id_historia} and id_historial = #{id_historial} and e.cod_esta=#{cod_esta} and id_tipo = #{id_tipo} and
           e.id_persona = #{id_persona} and e.id_consultorio = #{id_consultorio} 
     order by fecha desc limit 1
   </select>  
   
   <select id="getDatosEmergenciaUltimo" resultMap="datosHistorialEmer">  
     SELECT  id_historia,id_historial,e.id_persona,e.id_consultorio,e.fecha,repetida , diagnostico , subjetivo , objetivo, id_tipo_sexo as id_sexo, edad, 
     extract(month from age( e.fecha,fec_nacimiento))::int as mes, extract(day from age( e.fecha,fec_nacimiento))::int as dia,
     talla,peso, temperatura, expedido, e.id_persona,id_paciente,e.id_consultorio,codigo,rango,
     accion, a.id_estado,internado as id_cargo, a.id_seguro,a.cod_esta, antpato as cadena13,antfami as cadena14, antgineco as pa,
     histoemfer as fc,evolucion as registro, conducta as estimc, condicion as fr, observacion as nit, introduccion as cadena1,
     ant_nopato as cadena2,fisico_cabeza as cadena3,fisico_cara as cadena4,fisico_cuello as cadena5,fisico_torax as cadena6,
     fisico_corazon as cadena7,fisico_pulmon as cadena8,fisico_abdomen as cadena9,fisico_extrem as cadena10,observacion as cadena15,
     fisico_genito as cadena11,fisico_neuro as cadena12,id_tipo,he_accion as cadena20,he_diagnostico as cadena21,e.cod_esta
     from historiales  a
     join historiaemerg e using(id_historial)
     join pacientes using(id_paciente)
     where id_historia in (select max(id_historia) from historiaemerg where id_historial = #{id_historial} and cod_esta=#{cod_esta} 
            and id_tipo = #{id_tipo} and  id_persona = #{id_persona} and id_consultorio = #{id_consultorio}) 
     order by fecha desc limit 1
   </select>  
   
   <resultMap id="datoHistoriaEmer22" type="Historiales">
    <result property="id_historia"       column="id_historia"/>
    <result property="id_historial"      column="id_historial"/>
    <result property="id_tipo_sexo"      column="id_tipo_sexo"/>
    <result property="fecha"             column="fecha"/>          
    <result property="nombres"           column="nombres"/>
    <result property="consultorio"       column="consultorio"/>
    <result property="diagnostico"       column="diagnostico"/>
    <result property="subjetivo"         column="subjetivo"/>
    <result property="objetivo"          column="objetivo"/>    
    <result property="codigo"            column="codigo"/>  
    <result property="accion"            column="accion"/>
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>
    <result property="edad"              column="edad"/>
    <result property="mes"               column="mes"/>
    <result property="dia"               column="dia"/>
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>
    <result property="fr"                column="fr"/>
    <result property="so2"               column="so2"/>
    <result property="glicemia"          column="glicemia"/>
    <result property="estimc"            column="estimc"/>
    <result property="expedido"          column="expedido"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="id_persona"         column="id_persona"/>
    <result property="internado"         column="internado"/>
    <result property="embarazo"          column="embarazo"/>
    <result property="cama"              column="cama"/>
    <result property="nombre"            column="nombre"/>
    <result property="repetida"          column="repetida"/>
    <result property="registro"          column="registro"/>
    <result property="cadena1"           column="cadena1"/>
    <result property="cadena2"           column="cadena2"/>
    <result property="cadena3"           column="cadena3"/>
    <result property="cadena4"           column="cadena4"/>
    <result property="cadena5"           column="cadena5"/>
    <result property="cadena6"           column="cadena6"/>
    <result property="cadena7"           column="cadena7"/>
    <result property="cadena8"           column="cadena8"/>
    <result property="cadena9"           column="cadena9"/>
    <result property="cadena10"           column="cadena10"/>
    <result property="cadena11"           column="cadena11"/>
    <result property="cadena12"           column="cadena12"/> 
    <result property="cadena13"           column="cadena13"/> 
    <result property="cadena14"           column="cadena14"/> 
    <result property="cadena15"           column="cadena15"/> 
    <result property="cadena16"           column="cadena16"/> 
    <result property="cadena17"           column="cadena17"/> 
    <result property="cadena18"           column="cadena18"/> 
    <result property="cadena20"           column="cadena20"/>
    <result property="cadena21"           column="cadena21"/>
    <result property="id_tipo"            column="id_tipo"/>
    <result property="cod_esta"           column="cod_esta"/>
   </resultMap>
   
   <select id="getListarHistoriaEmergen" resultMap="datoHistoriaEmer22"> 
     select id_historia,id_historial,e.fecha, (SELECT     personas.paterno||' ' ||personas.materno||' ' ||personas.nombres AS Expr1 
                FROM   personas WHERE  (id_persona = e.id_persona)) AS nombres,consultorio,subjetivo,
                (CASE WHEN he_diagnostico is null THEN (CASE WHEN diagnostico is null THEN 'SD' ELSE diagnostico END) ELSE he_diagnostico END) as diagnostico,
        objetivo,cie10.codigo||' '||literal as codigo,accion, talla, peso, h.id_estado, edad,
        extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido, h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        establecimiento as cama,a.nombres as nombre,antpato as repetida,antfami as registro,antgineco as cadena1, histoemfer as cadena2, 
        evolucion as cadena3, conducta as cadena4, condicion as cadena5, observacion as cadena6,so2,glicemia,
        introduccion as cadena7,ant_nopato as cadena8,fisico_cabeza as cadena9,fisico_cara as cadena10,fisico_cuello as cadena11,
        fisico_torax as cadena12,fisico_corazon as cadena13,fisico_pulmon as cadena14,fisico_abdomen as cadena15,
        fisico_extrem as cadena16,fisico_genito as cadena17,fisico_neuro as cadena18,a.id_tipo_sexo,id_tipo,
        he_accion as cadena20,he_diagnostico as cadena21,e.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN pacientes a USING(id_paciente)
       JOIN historiaemerg e USING(id_historial)
       join cie10 ON cie10.codigo = h.codigo 
       join establecimientos ON establecimientos.cod_esta = h.cod_esta
     where id_tipo = #{id_tipo} and id_paciente in (select id_paciente from historiales where id_historial=#{id_historial} and cod_esta=#{cod_esta}) 
     order by fecha desc,-id_historia  limit 10 
  </select> 
  
  <select id="getListarHistoriaEmergenGen" resultMap="datoHistoriaEmer22"> 
     select id_historia,id_historial,e.fecha, (SELECT     personas.paterno||' ' ||personas.materno||' ' ||personas.nombres AS Expr1 
                FROM   personas WHERE  (id_persona = e.id_persona)) AS nombres,consultorio,subjetivo,
                (CASE WHEN he_diagnostico is null THEN (CASE WHEN diagnostico is null THEN 'SD' ELSE diagnostico END) ELSE he_diagnostico END) as diagnostico,
        objetivo,cie10.codigo||' '||literal as codigo,accion, talla, peso, h.id_estado, edad,
        extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido, h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        establecimiento as cama,a.nombres as nombre,antpato as repetida,antfami as registro,antgineco as cadena1, histoemfer as cadena2, 
        evolucion as cadena3, conducta as cadena4, condicion as cadena5, observacion as cadena6,so2,glicemia,
        introduccion as cadena7,ant_nopato as cadena8,fisico_cabeza as cadena9,fisico_cara as cadena10,fisico_cuello as cadena11,
        fisico_torax as cadena12,fisico_corazon as cadena13,fisico_pulmon as cadena14,fisico_abdomen as cadena15,
        fisico_extrem as cadena16,fisico_genito as cadena17,fisico_neuro as cadena18,a.id_tipo_sexo,id_tipo,
        he_accion as cadena20,he_diagnostico as cadena21,e.cod_esta
     from historiaemerg e
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN historiales h USING(id_historial)
       JOIN pacientes a USING(id_paciente)
       join cie10 ON cie10.codigo = h.codigo 
       join establecimientos ON establecimientos.cod_esta = h.cod_esta
     where id_paciente in (select id_paciente from historiales where id_historial=#{id_historial} and cod_esta=#{cod_esta} 
     order by fecha desc,-id_historia  limit 10 
  </select> 
  
  <select id="getDatosEmergencias" resultMap="datoHistoriaEmer22">  
    select id_historia,id_historial,e.fecha,  (SELECT     personas.paterno||' ' ||personas.materno||' ' ||personas.nombres AS Expr1 
                 FROM   personas WHERE  (id_persona = e.id_persona)) AS nombres,consultorio,subjetivo,
                (CASE WHEN he_diagnostico is null THEN (CASE WHEN diagnostico is null THEN 'SD' ELSE diagnostico END) ELSE he_diagnostico END) as diagnostico,
        objetivo,cie10.codigo||' '||literal as codigo,accion, talla, peso, h.id_estado, edad,
        extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido, h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        establecimiento as cama,a.nombres as nombre,antpato as repetida,antfami as registro,antgineco as cadena1, histoemfer as cadena2, 
        evolucion as cadena3, conducta as cadena4, condicion as cadena5, observacion as cadena6,so2,glicemia,
        introduccion as cadena7,ant_nopato as cadena8,fisico_cabeza as cadena9,fisico_cara as cadena10,fisico_cuello as cadena11,
        fisico_torax as cadena12,fisico_corazon as cadena13,fisico_pulmon as cadena14,fisico_abdomen as cadena15,
        fisico_extrem as cadena16,fisico_genito as cadena17,fisico_neuro as cadena18,a.id_tipo_sexo,id_tipo,
        he_accion as cadena20,he_diagnostico as cadena21,e.cod_esta
     from historiaemerg e
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN historiales h USING(id_historial)
       JOIN pacientes a USING(id_paciente)
       join cie10 ON cie10.codigo = h.codigo 
       join establecimientos ON establecimientos.cod_esta = h.cod_esta
     where  id_historial = #{id_historial}  and id_tipo = #{id_tipo}  
     order by fecha desc limit 1
     <!--id_historia = #{id_historia} and se aumenta 07-12-2016 para que salga la impresion solo de ese id_historia -->
   </select>  
  
  <select id="getListarHistoriaEmergen333" resultMap="datoHistoriaEmer22"> 
     select id_historia,id_historial,e.fecha, (SELECT     personas.paterno||' ' ||personas.materno||' ' ||personas.nombres AS Expr1 
                FROM   personas WHERE  (id_persona = e.id_persona)) AS nombres,consultorio,subjetivo,
                (CASE WHEN he_diagnostico is null THEN (CASE WHEN diagnostico is null THEN 'SD' ELSE diagnostico END) ELSE he_diagnostico END) as diagnostico,
        objetivo,cie10.codigo||' '||literal as codigo,accion, talla, peso, h.id_estado, edad,
        extract(month from age( h.fecha,a.fec_nacimiento))::int as mes,extract(day from age( h.fecha,a.fec_nacimiento))::int as dia,
        temperatura,fc,pa,fr,firma as estimc, expedido, h.id_seguro,h.id_persona,internado,embaraza as embarazo,
        establecimiento as cama,a.nombres as nombre,antpato as repetida,antfami as registro,antgineco as cadena1, histoemfer as cadena2, 
        evolucion as cadena3, conducta as cadena4, condicion as cadena5, observacion as cadena6,so2,glicemia,
        introduccion as cadena7,ant_nopato as cadena8,fisico_cabeza as cadena9,fisico_cara as cadena10,fisico_cuello as cadena11,
        fisico_torax as cadena12,fisico_corazon as cadena13,fisico_pulmon as cadena14,fisico_abdomen as cadena15,
        fisico_extrem as cadena16,fisico_genito as cadena17,fisico_neuro as cadena18,a.id_tipo_sexo,id_tipo,
        he_accion as cadena20,he_diagnostico as cadena21,e.cod_esta
     from historiales h
       JOIN consultorios c USING(id_consultorio)
       JOIN personas p USING(id_persona)
       JOIN pacientes a USING(id_paciente)
       JOIN historiaemerg e USING(id_historial)
       join cie10 ON cie10.codigo = h.codigo 
       join establecimientos ON establecimientos.cod_esta = h.cod_esta
     WHERE e.cod_esta=#{cod_esta} and id_paciente=#{id_paciente} and id_historial=#{id_historial} and id_historia in 
        (select max(id_historia) from historiaemerg where cod_esta=#{cod_esta} and id_historial=#{id_historial}) 
        limit 10
  </select> 
  
  <resultMap id="datosHistorialRev" type="Historiales">
    <result property="id_historial"      column="id_historial"/>  
    <result property="fecha"             column="fecha"/>         
    <result property="id_sexo"           column="id_sexo"/>   
    <result property="edad"              column="edad"/>   
    <result property="mes"               column="mes"/>   
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>    
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>    
    <result property="fr"                column="fr"/>   
    <result property="so2"               column="so2"/>
    <result property="glicemia"          column="glicemia"/> 
    <result property="expedido"          column="expedido"/>            
    <result property="id_persona"        column="id_persona"/>            
    <result property="id_paciente"       column="id_paciente"/>            
    <result property="id_consultorio"    column="id_consultorio"/> 
    <result property="id_estado"         column="id_estado"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="vigencia"          column="vigencia"/>
    <result property="triaje"            column="triaje"/>
    <result property="fechalab"          column="fechalab"/> 
    <result property="tipoconsult"       column="tipoconsult"/> 
    <result property="id_riesgo"         column="id_riesgo"/> 
  </resultMap>

  <select id="getDatosReserva" resultMap="datosHistorialRev">  
    select  id_reservacion as id_historial,r.fecha, id_tipo_sexo as id_sexo, r.edad,extract(month from age( r.fecha,
    fec_nacimiento))::int as mes, r.talla,r.peso, r.temperatura, r.fc, r.pa, r.fr,so2,glicemia, r.expedido,id_persona,
    r.id_paciente,id_consultorio,r.id_estado,r.id_seguro,vigencia,triaje,fec_reg as fechalab,tipoconsult,id_riesgo
     from reservaciones r
     join pacientes using(id_paciente)
     where id_reservacion = #{id_historial} and r.cod_esta=#{cod_esta} 
   </select>  
   
   <resultMap id="datosHistorialULT" type="Historiales">
    <result property="id_historial"      column="id_historial"/>  
    <result property="fecha"             column="fecha"/>         
    <result property="repetida"          column="repetida"/>   
    <result property="diagnostico"       column="diagnostico"/>  
    <result property="subjetivo"         column="subjetivo"/>  
    <result property="objetivo"          column="objetivo"/>  
    <result property="accion"            column="accion"/>  
    <result property="id_sexo"           column="id_sexo"/>   
    <result property="edad"              column="edad"/>   
    <result property="mes"               column="mes"/>   
    <result property="talla"             column="talla"/>
    <result property="peso"              column="peso"/>    
    <result property="temperatura"       column="temperatura"/>
    <result property="fc"                column="fc"/>
    <result property="pa"                column="pa"/>    
    <result property="fr"                column="fr"/>   
    <result property="so2"               column="so2"/>  
    <result property="glicemia"          column="glicemia"/>  
    <result property="expedido"          column="expedido"/>            
    <result property="id_persona"        column="id_persona"/>            
    <result property="id_paciente"       column="id_paciente"/>            
    <result property="id_consultorio"    column="id_consultorio"/> 
    <result property="codigo"            column="codigo"/>  
    <result property="rango"             column="rango"/>  
    <result property="id_estado"         column="id_estado"/>
    <result property="id_seguro"         column="id_seguro"/>
    <result property="vigencia"          column="vigencia"/>
  </resultMap>
 
   <select id="getDatosHistorialUlt" resultMap="datosHistorialULT">  
     SELECT  id_historial,fecha,repetida, diagnostico , subjetivo , objetivo, 0 as id_sexo, edad, 0 as mes, talla,peso, 
      temperatura, fc, pa, fr, expedido,id_persona,id_paciente,id_consultorio,codigo,rango,accion, id_estado,
      internado as id_cargo,id_seguro,vigencia,so2,glicemia
      from historiales
      where id_historial=(select max(id_historial) from historiales where id_paciente=#{id_historial} and talla!=0 and peso!=0)
   </select>
   
   <select id="getDatosHistorialUltHisto" resultMap="datosHistorialULT">  
     SELECT  id_historial,fecha,repetida, diagnostico , subjetivo , objetivo, 0 as id_sexo, edad, 0 as mes, talla,peso, 
       temperatura, fc, pa, fr, expedido,id_persona,id_paciente,id_consultorio,codigo,rango,accion, id_estado,
       internado as id_cargo,id_seguro,vigencia,so2,glicemia
     from historiales
     where id_historial=(select max(id_historial) from historiales 
            where id_persona=#{id_persona} and id_paciente=#{id_paciente} and cod_esta=#{cod_esta}) 
   </select>
   
   <resultMap id="datoKardexPaciente" type="Historiales">
    <result property="id_historial"      column="id_historial"/>   
    <result property="fecha"             column="fecha"/>
    <result property="hcl"               column="hcl"/>    
    <result property="nombres"           column="nombres"/>
    <result property="direccion"         column="direccion"/>    
    <result property="registro"          column="registro"/>    
    <result property="codigo"            column="codigo"/>        
    <result property="peso"              column="peso"/>        
  </resultMap>
  
  <select id="getListarKardexPaciente" resultMap="datoKardexPaciente">  
     select id_historial,k.fecha ,hcl,p.nombres,direccion,nro_registro as registro,nit as codigo,salida as peso 
       from kardex k 
         join pedidos e using(id_pedido)
         join pacientes p using(id_paciente)
     where id_medicamento=#{id_cargo} and fecha::date BETWEEN #{fecha_ini}  and #{fecha_fin} and k.cod_esta=#{id_localidad} 
     order by k.fecha
  </select> 
    
  <resultMap id="datoPacientePrestacion" type="Historiales">
    <result property="id_historial"      column="id_historial"/>   
    <result property="registro"          column="registro"/>          
    <result property="hcl"               column="hcl"/>    
    <result property="paterno"           column="paterno"/>
    <result property="materno"           column="materno"/>
    <result property="nombre"            column="nombre"/>
    <result property="dia"               column="dia"/>
    <result property="dial"              column="dial"/>
    <result property="edad"              column="edad"/>
    <result property="mes"               column="mes"/>
    <result property="edad_ini"          column="edad_ini"/>
    <result property="repetida"          column="repetida"/>    
    <result property="id_sexo"           column="id_sexo"/>    
    <result property="codigo"            column="codigo"/>        
    <result property="rango"             column="rango"/>        
  </resultMap>
  
  <select id="getListarPacientesHistoGeneral" resultMap="datoPacientePrestacion">  
     select id_historial,fecha::date as registro,hcl, e.paterno,e.materno,e.nombres as nombre,extract(day from fecha)as dia,
     extract(day from fechalab)as dial, edad, extract(month from age( fecha,p.fec_nacimiento))::int as mes, 
     extract(day from age( fecha,p.fec_nacimiento))::int as edad_ini,repetida, p.id_tipo_sexo as id_sexo,codigo,rango
     from historiales 
     join pacientes p using(id_paciente)
     join personas e using(id_persona)	
     where id_historial in
    (select distinct(id_historial)
     from historiales 
     join pacientes using(id_paciente)
     join recetass using(id_historial)
     where historiales.id_paciente=#{id_paciente} 
     )
     order by fechalab,fecha,id_historial
   </select> 
   
  <select id="getListarPacientesHistoNeo" resultMap="datoPacientePrestacion">  
     select id_historial,nro_registro as registro,hcl,paterno,materno,nombre,extract(day from fecha)as dia,
     extract(day from fechalab)as dial, edad, extract(month from age( fecha,fec_nacimiento))::int as mes, 
     extract(day from age( fecha,fec_nacimiento))::int as edad_ini,repetida, id_tipo_sexo as id_sexo,codigo,rango
     from historiales 
     join pacientes using(id_paciente)
     where id_historial in
     (select distinct(id_historial)
     from historiales 
     join pacientes using(id_paciente)
     join recetass using(id_historial)
     where (recetass.fecha::date BETWEEN #{fecha_ini} and #{fecha_fin})  and recetass.id_persona=#{id_persona} and edad =0 and  
     extract(month from age( historiales.fecha,fec_nacimiento))=0 and  not extract(day from age( historiales.fecha,fec_nacimiento))>28
     )
     order by fechalab,fecha,id_historial
   </select> 
   
   <select id="getListarPacientesHistoPedi" resultMap="datoPacientePrestacion">  
     select id_historial,nro_registro as registro,hcl,paterno,materno,nombre,extract(day from fecha)as dia,
     extract(day from fechalab)as dial, edad, extract(month from age( fecha,fec_nacimiento))::int as mes, 
     extract(day from age( fecha,fec_nacimiento))::int as edad_ini,repetida, id_tipo_sexo as id_sexo,codigo,rango
     from historiales 
     join pacientes using(id_paciente)
     where id_historial in
     (select distinct(id_historial)
     from historiales 
     join pacientes using(id_paciente)
     join recetass using(id_historial)
     where (recetass.fecha::date BETWEEN #{fecha_ini} and #{fecha_fin}) and recetass.id_persona=#{id_persona} and 
     (edad BETWEEN 0 and 5 ) and  not (edad =0 and  extract(month from age(historiales.fecha,fec_nacimiento))=0 and  not extract(day from age( historiales.fecha,fec_nacimiento))>28) 
     )
      order by fechalab,fecha,id_historial
   </select>
   
   <select id="getListarPacientesHistoMuje" resultMap="datoPacientePrestacion">  
     select id_historial,nro_registro as registro,hcl,paterno,materno,nombre,extract(day from fecha)as dia,
     extract(day from fechalab)as dial, edad, extract(month from age( fecha,fec_nacimiento))::int as mes, 
     extract(day from age( fecha,fec_nacimiento))::int as edad_ini,repetida, id_tipo_sexo as id_sexo,codigo,rango
     from historiales 
     join pacientes using(id_paciente)
     where  id_historial in
     ( select distinct(id_historial)
     from historiales 
     join pacientes using(id_paciente)
     join recetass using(id_historial)
     where (recetass.fecha::date BETWEEN #{fecha_ini} and #{fecha_fin}) and recetass.id_persona=#{id_persona} and 
     (edad BETWEEN 6 and 59 )
     )
      order by fechalab,fecha,id_historial
   </select>
   
   <select id="getListarPacientesHistoMayor" resultMap="datoPacientePrestacion">  
     select id_historial,nro_registro as registro,hcl,paterno,materno,nombre,extract(day from fecha)as dia,
     extract(day from fechalab)as dial, edad, extract(month from age( fecha,fec_nacimiento))::int as mes, 
     extract(day from age( fecha,fec_nacimiento))::int as edad_ini,repetida, id_tipo_sexo as id_sexo,codigo,rango
     from historiales 
     join pacientes using(id_paciente)
     where  id_historial in
     ( select distinct(id_historial)
     from historiales 
     join pacientes using(id_paciente)
     join recetass using(id_historial)
     where (recetass.fecha::date BETWEEN #{fecha_ini} and #{fecha_fin})  and prestacion!='LECHE' and recetass.id_persona=#{id_persona} and 
     (edad BETWEEN 60 and 150 )
     )
      order by fechalab,fecha,id_historial
   </select>
   
  <resultMap id="datoPaciente19" type="Historiales">
    <result property="id_historial"      column="id_historial"/>   
    <result property="registro"          column="registro"/>
    <result property="fecha"             column="fecha"/>   
    <result property="hcl"               column="hcl"/>    
    <result property="paterno"           column="paterno"/>
    <result property="materno"           column="materno"/>
    <result property="nombre"            column="nombre"/>
    <result property="edad"              column="edad"/>
    <result property="mes"               column="mes"/>
    <result property="diagnostico"       column="diagnostico"/>
    <result property="accion"            column="accion"/>
    <result property="repetida"          column="repetida"/>    
    <result property="id_sexo"           column="id_sexo"/>    
    <result property="codigo"            column="codigo"/>              
  </resultMap>
  
   <select id="getListarPacientes19" resultMap="datoPaciente19">  
     select id_historial,nro_registro as registro,fecha,hcl,paterno,materno,nombre, edad, extract(month from age( fecha,fec_nacimiento))::int as mes,
     diagnostico,accion,repetida, id_tipo_sexo as id_sexo,codigo,id_persona
     from historiales 
     join pacientes using(id_paciente)
     where (fecha::date BETWEEN #{fecha_ini} and #{fecha_fin}) and id_persona=#{id_persona} and (edad BETWEEN 11 and 19 ) and codigo is not null
     order by fecha
   </select>
   
   <select id="getListarPacientes19T" resultMap="datoPaciente19">  
     select id_historial,nro_registro as registro,fecha,hcl,paterno,materno,nombre, edad, extract(month from age( fecha,fec_nacimiento))::int as mes,
     diagnostico,accion,repetida, id_tipo_sexo as id_sexo,codigo,id_persona
     from historiales 
     join pacientes using(id_paciente)
     where (fecha::date BETWEEN #{fecha_ini} and #{fecha_fin}) and (edad BETWEEN 11 and 19 ) and codigo is not null
     order by fecha
   </select>
   
    <resultMap id="datoPacienteSpam" type="Historiales">
    <result property="id_historial"      column="id_historial"/>   
    <result property="registro"          column="registro"/>
    <result property="fecha"             column="fecha"/>   
    <result property="hcl"               column="hcl"/>    
    <result property="paterno"           column="paterno"/>
    <result property="materno"           column="materno"/>
    <result property="nombre"            column="nombre"/>
    <result property="edad"              column="edad"/>
    <result property="mes"               column="mes"/>
    <result property="diagnostico"       column="diagnostico"/>
    <result property="accion"            column="accion"/>
    <result property="repetida"          column="repetida"/>    
    <result property="id_sexo"           column="id_sexo"/>    
    <result property="codigo"            column="codigo"/>              
  </resultMap>
  
   <select id="getListarPacientesSpam" resultMap="datoPacienteSpam">  
     select id_historial,nro_registro as registro,fecha,hcl,paterno,materno,nombre, edad, 
     extract(month from age( fecha,fec_nacimiento))::int as mes,diagnostico,accion,repetida, 
     id_tipo_sexo as id_sexo,codigo,id_persona
     from historiales 
     join pacientes using(id_paciente)
     where (fecha::date BETWEEN #{fecha_ini} and #{fecha_fin})  and expedido='P'
     order by fecha
   </select>
  
 <resultMap id="datosEconomicosLab" type="Historiales">
    <result property="id_pedido"          column="id_pedido"/>
    <result property="id_historial"          column="id_historial"/>
    <result property="id_estado"             column="id_estado"/>
    <result property="nombres"               column="nombres"/> 
    <result property="edad"                  column="edad"/>      
    <result property="expedido"              column="expedido"/>            
    <result property="fecha"                 column="fecha"/>    
    <result property="id_persona"            column="id_persona"/>  
    <result property="id_consultorio"        column="id_consultorio"/>    
    <result property="id_paciente"           column="id_paciente"/>  
    <result property="id_seguro"             column="id_seguro"/>
    <result property="nro_registro"          column="nro_registro"/>
  </resultMap>
  
  <select id="getResumenEconomicoLab" resultMap="datosEconomicosLab">  
     SELECT id_pedido,id_historial,historiales.id_estado,p.nombres,l.id_persona,fechae as fecha,id_consultorio,id_paciente,edad,expedido,historiales.id_seguro,nro_registro 
     FROM historiales join pedidoslab l using(id_historial) join pacientes p using(id_paciente) 
	  where historiales.id_seguro=#{id_seguro} and internado=#{internado} and (fechae::date BETWEEN #{fecha_ini} and #{fecha_fin}) and id_historial in 
         (SELECT id_historial FROM pedidoslab where id_estado='B' and (fechae::date BETWEEN #{fecha_ini} and #{fecha_fin} ) 
	  order by fecha,id_pedido,id_historial   
  </select> 
  
  <select id="getResumenEconomicoEco" resultMap="datosEconomicosLab">  
     SELECT 0 as id_pedido,id_historial,h.id_estado,p.nombres,c.id_persona,fechap as fecha,c.id_consultorio,id_paciente,h. edad,tratamiento as expedido,h.id_seguro,nro_registro 
     from cuaderno6 c
        join historiales h using (id_historial)
        join pacientes p using (id_paciente)
	  where h.id_seguro=#{id_seguro} and internado=#{internado} and  (fechap::date BETWEEN #{fecha_ini} and #{fecha_fin} )  
	  order by fecha,id_historial
  </select> 
  
  <resultMap id="datosEconomicos18" type="Historiales">
    <result property="id_historial"          column="id_historial"/>
    <result property="id_estado"             column="id_estado"/>
    <result property="nombres"               column="nombres"/> 
    <result property="edad"                  column="edad"/>      
    <result property="expedido"              column="expedido"/>            
    <result property="fecha"                 column="fecha"/>    
    <result property="id_persona"            column="id_persona"/>  
    <result property="id_consultorio"        column="id_consultorio"/>    
    <result property="id_paciente"           column="id_paciente"/>  
    <result property="id_seguro"             column="id_seguro"/>
    <result property="nro_registro"          column="nro_registro"/>
    <result property="talla"                 column="talla"/>
    <result property="peso"                  column="peso"/>
    <result property="id_localidad"          column="id_localidad"/>  
    <result property="suma1"                 column="suma1"/>
    <result property="suma2"                 column="suma2"/>
    <result property="suma3"                 column="suma3"/>
    <result property="suma4"                 column="suma4"/>
    <result property="suma5"                 column="suma5"/>
    <result property="suma6"                 column="suma6"/>
    <result property="suma7"                 column="suma7"/>
    <result property="suma8"                 column="suma8"/>
  </resultMap>
  
  <select id="getResumenEconomico" resultMap="datosEconomicos18">  
     select * from _reporte_economico(#{id_seguro},#{internado},#{fecha_ini},#{fecha_fin}) 
            as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
     id_persona integer,id_consultorio integer,id_paciente integer,id_seguro integer,nro_registro text,talla float,
     peso float,id_localidad float,suma1 float,suma2 float,suma3 float,suma4 float,suma5 float,
     suma6 float,suma7 float,suma8 float)
  </select> 
  
  
  <resultMap id="datosEconomicos" type="Historiales">
    <result property="id_historial"          column="id_historial"/>
    <result property="id_estado"             column="id_estado"/>
    <result property="nombres"               column="nombres"/> 
    <result property="edad"                  column="edad"/>      
    <result property="expedido"              column="expedido"/>            
    <result property="fecha"                 column="fecha"/>    
    <result property="id_persona"            column="id_persona"/>  
    <result property="id_consultorio"        column="id_consultorio"/>    
    <result property="id_paciente"           column="id_paciente"/>  
    <result property="id_seguro"             column="id_seguro"/>
    <result property="internado"             column="internado"/>
    <result property="nro_registro"          column="nro_registro"/>
    <result property="accion"                column="accion"/>
    <result property="suma1"                 column="suma1"/>
    <result property="suma2"                 column="suma2"/>
    <result property="suma3"                 column="suma3"/>
    <result property="suma4"                 column="suma4"/>
    <result property="suma5"                 column="suma5"/>
    <result property="suma6"                 column="suma6"/>
    <result property="suma7"                 column="suma7"/>
    <result property="suma8"                 column="suma8"/> 
    <result property="suma9"                 column="suma9"/>
    <result property="suma10"                column="suma10"/>
    <result property="suma11"                column="suma11"/>
    <result property="suma12"                column="suma12"/>
    <result property="cod_esta"              column="cod_esta"/>
  </resultMap>
  
  <select id="getResumenEconomicoj" resultMap="datosEconomicos">  
     select id_historial,fecha,h.id_estado,nombres,edad,expedido,id_persona, id_consultorio,id_paciente,h.id_seguro,
             internado,seguro as accion,nro_registro,n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5,     
             n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12,
             cod_esta
      from historiales h
      join pacientes using(id_paciente)
      where cod_esta=#{cod_esta} and (date(h.fecha) BETWEEN #{fecha_ini} and #{fecha_fin}) and (h.id_seguro between #{suma3} and #{suma4})  
            and internado in (select id_tipoi from tipos_inter where internado between #{suma1} and #{suma2})
      order by fecha,id_historial
  </select> 
  
  <select id="getResumenEconomicoTot" resultMap="datosEconomicos">  
     select id_historial,fecha,h.id_estado,nombres,edad,expedido,id_persona, id_consultorio,id_paciente,h.id_seguro,
             internado,seguro as accion,nro_registro,n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5,     
             n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12,
             cod_esta
      from historiales h
      join pacientes using(id_paciente)
      where cod_esta=#{cod_esta} and (date(h.fecha) BETWEEN #{fecha_ini} and #{fecha_fin}) and (h.id_seguro between 1 and 5) and
            internado in (select id_tipoi from tipos_inter where internado between 2 and 3 )
      order by fecha,id_historial
      <!-- parace que ya no sirve 14-01-2017 esta por demas-->
  </select> 
  
  <!--
   <resultMap id="datosHistorialResumenLib" type="Historiales">
    <result property="id_historial"          column="id_historial"/>  
    <result property="cod_esta"              column="cod_esta"/>  
    <result property="suma1"                 column="suma1"/>
    <result property="suma2"                 column="suma2"/>
    <result property="suma3"                 column="suma3"/>
    <result property="suma4"                 column="suma4"/>
    <result property="suma5"                 column="suma5"/>
    <result property="suma6"                 column="suma6"/>
    <result property="suma7"                 column="suma7"/>
    <result property="suma8"                 column="suma8"/>
    <result property="suma9"                 column="suma9"/>
    <result property="suma10"                column="suma10"/>
    <result property="suma11"                column="suma11"/>
    <result property="suma12"                column="suma12"/>
  </resultMap>
  
  <select id="getHistorialResLibros" resultMap="datosHistorialResumenLib">  
    select id_historial,cod_esta,sum(suma1)::int as suma1, sum(suma2)::int as suma2, sum(suma3)::int as suma3, sum(suma4)::int as suma4, 
       sum(suma5)::int as suma5, sum(suma6)::int as suma6, sum(suma7)::int as suma7, sum(suma8)::int as suma8, sum(suma9)::int as suma9, 
       sum(suma10)::int as suma10, sum(suma11)::int as suma11, sum(suma12)::int as suma12
     from 
     ((select id_historial,h.cod_esta,count(id_detalle) as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5, 0 as suma6, 
           0 as suma7,0 as suma8,0 as suma9,0 as suma10,0 as suma11,0 as suma12  
        from historiales h    join recetass r using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin})  and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta)
    union
    (select id_historial,h.cod_esta,0 as suma1,count(id_detalle) as suma2, 0 as suma3, 0 as suma4, 0 as suma5, 0 as suma6, 
          0 as suma7,0 as suma8,0 as suma9,0 as suma10,0 as suma11,0 as suma12
        from historiales h    join recetas r using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin})  and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta)
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, count(id_cuaderno) as suma3, 0 as suma4,0 as suma5,0 as suma6,
           0 as suma7,0 as suma8,0 as suma9,0 as suma10,0 as suma11,0 as suma12
        from historiales h   join cuaderno1 using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin}) and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta)
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2,0 as suma3,count(id_cuaderno) as suma4, 0 as suma5, 0 as suma6, 
           0 as suma7,0 as suma8,0 as suma9,0 as suma10,0 as suma11,0 as suma12
        from historiales h    join cuaderno2 using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin})  and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta)  
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, count(id_cuaderno) as suma5,0 as suma6, 
           0 as suma7, 0 as suma8,0 as suma9,0 as suma10,0 as suma11,0 as suma12
        from historiales h    join cuaderno3 using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin})  and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta) 
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5,count(id_cuaderno) as suma6, 
            0 as suma7, 0 as suma8,0 as suma9,0 as suma10,0 as suma11,0 as suma12 
        from historiales h    join cuaderno4 using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin}) and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta) 
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5, 0 as suma6, 
           count(id_cuaderno) as suma7, 0 as suma8, 0 as suma9, 0 as suma10, 0 as suma11,0 as suma12  
        from historiales h    join cuaderno5 using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin}) and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta) 
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5,0 as suma6, 
            0 as suma7, count(id_cuaderno) as suma8, 0 as suma9, 0 as suma10, 0 as suma11, 0 as suma12  
        from historiales h    join cuaderno6 using(id_historial)
        where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin}) and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta) 
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5,0 as suma6, 
           0 as suma7, 0 as suma8, count(id_cuaderno) as suma9, 0 as suma10, 0 as suma11, 0 as suma12  
        from historiales h     join cuaderno7 using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin}) and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta) 
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5, 0 as suma6, 
           0 as suma7, 0 as suma8, 0 as suma9, count(id_cuaderno) as suma10, 0 as suma11, 0 as suma12  
         from historiales h     join vacunas using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin})  and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta)  
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5, 0 as suma6, 
           0 as suma7, 0 as suma8, 0 as suma9, 0 as suma10, count(id_cuaderno) as suma11, 0 as suma12  
        from historiales h    join cuadernof using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin}) and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta)  
    union
    (select id_historial,h.cod_esta,0 as suma1, 0 as suma2, 0 as suma3, 0 as suma4, 0 as suma5, 0 as suma6, 
           0 as suma7, 0 as suma8, 0 as suma9, 0 as suma10, 0 as suma11, count(id_cuaderno) as suma12  
        from historiales h     join laboratorio using(id_historial)
         where h.cod_esta=#{cod_esta} and h.fecha::date between date(#{fecha_ini}) and date(#{fecha_fin}) and h.id_persona between #{id_persona} and #{id_por} 
         group by id_historial,h.cod_esta) ) as consulta 

        group by id_historial,cod_esta     
    </select> 
    -->
    <resultMap id="datosHistorialResumenNuevo" type="Historiales">
        <result property="id_historial"          column="id_historial"/>
        <result property="id_estado"             column="id_estado"/>
        <result property="nombres"               column="nombres"/> 
        <result property="edad"                  column="edad"/>      
        <result property="expedido"              column="expedido"/>            
        <result property="fecha"                 column="fecha"/>    
        <result property="id_persona"            column="id_persona"/>  
        <result property="id_consultorio"        column="id_consultorio"/>    
        <result property="id_paciente"           column="id_paciente"/> 
        <result property="id_seguro"             column="id_seguro"/>
        <result property="accion"                column="accion"/>
        <result property="suma1"                 column="suma1"/>
        <result property="suma2"                 column="suma2"/>
        <result property="suma3"                 column="suma3"/>
        <result property="suma4"                 column="suma4"/>
        <result property="suma5"                 column="suma5"/>
        <result property="suma6"                 column="suma6"/>
        <result property="suma7"                 column="suma7"/>
        <result property="suma8"                 column="suma8"/>
        <result property="suma9"                 column="suma9"/>
        <result property="suma10"                column="suma10"/>
        <result property="suma11"                column="suma11"/>
        <result property="suma12"                column="suma12"/>
        <result property="tipoconsult"          column="tipoconsult"/>
        <result property="id_riesgo"             column="id_riesgo"/>
        <result property="cod_esta"              column="cod_esta"/>
    </resultMap>
   
    <select id="getHistorialAtendidos" resultMap="datosHistorialResumenNuevo">  
        select id_historial,fecha,h.id_estado,nombres,edad,expedido,id_persona, id_consultorio,id_paciente,h.id_seguro,
        internado,seguro as accion,n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5,     
        n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12,
        tipoconsult,id_riesgo,h.cod_esta
        from historiales h
        join pacientes using(id_paciente)
        where h.diagnostico!='Desde Farmacia' and h.id_persona=#{id_persona} and (internado between 0 and 1) and
        h.fecha::timestamp between (now()::timestamp - interval '14 hours') and (now()::timestamp + interval '12 hours')
        order by fecha,id_historial
    </select> 
  
    <resultMap id="datosHistorialResumen" type="Historiales">
        <result property="id_historial"          column="id_historial"/>
        <result property="id_estado"             column="id_estado"/>
        <result property="nombres"               column="nombres"/> 
        <result property="edad"                  column="edad"/>      
        <result property="expedido"              column="expedido"/>            
        <result property="fecha"                 column="fecha"/>    
        <result property="id_persona"            column="id_persona"/>  
        <result property="id_consultorio"        column="id_consultorio"/>    
        <result property="id_paciente"           column="id_paciente"/>    
        <result property="edad_ini"              column="edad_ini"/>     
        <result property="edad_fin"              column="edad_fin"/>     
        <result property="id_tipo_documento"     column="id_tipo_documento"/>    
        <result property="id_tipo_parentesco"    column="id_tipo_parentesco"/>    
        <result property="id_pais"               column="id_pais"/>    
        <result property="id_departamento"       column="id_departamento"/>
        <result property="num"                   column="num"/> 
        <result property="id_provincia"          column="id_provincia"/>         
        <result property="id_localidad"          column="id_localidad"/>
        <result property="id_reservacion"        column="id_reservacion"/>
        <result property="embarazo"              column="embarazo"/>
        <result property="id_cargo"              column="id_cargo"/>   
        <result property="rango"                 column="rango"/>  
        <result property="id_seguro"             column="id_seguro"/>
    </resultMap>
  
    <select id="getHistorialLibros" resultMap="datosHistorialResumen">  
        select * from _verifica_atencion_libros(#{id_historial} ) 
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone, 
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer,
        id_tipo_documento integer,id_tipo_parentesco integer,id_pais integer,id_departamento integer,num integer,
        id_provincia integer,id_localidad integer,id_reservacion integer,embarazo integer,id_cargo integer,
        rango integer,id_seguro integer)
    </select> 
  
    <select id="getHistorialAtendidosP" resultMap="datosHistorialResumen">  
        select * from _verifica_atencionpas(#{id_persona} ) 
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,id_tipo_parentesco integer,id_pais integer,id_departamento integer,num integer,
        id_provincia integer,id_localidad integer,id_reservacion integer,embarazo integer,id_cargo integer,
        rango integer,id_seguro integer)
        order by fecha  
    </select> 
  
    <select id="getHistorialAtendidosFecha" resultMap="datosHistorialResumen">  
        select * from _verifica_atencion_fecha(#{id_persona},#{fecha_ini},#{fecha_fin})  
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,id_tipo_parentesco integer,id_pais integer,id_departamento integer,num integer,
        id_provincia integer,id_localidad integer,id_reservacion integer,embarazo integer,id_cargo integer,
        rango integer,id_seguro integer)
        order by expedido,fecha,nombres
    </select>  
  
    <select id="getAtendidosInter" resultMap="datosHistorialResumen">  
        select * from _verifica_atencion_fecha_inter(#{fecha_ini},#{fecha_fin} ) 
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,id_tipo_parentesco integer,id_pais integer,id_departamento integer,num integer,
        id_provincia integer,id_localidad integer,id_reservacion integer,embarazo integer,id_cargo integer,
        rango integer,id_seguro integer)
        order by fecha,nombres
    </select>  
  
    <select id="getAtendidosInterSala" resultMap="datosHistorialResumen">  
        select * from _verifica_atencion_fecha_inter_sala(#{fecha_ini},#{fecha_fin},#{id_cargo})  
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,id_tipo_parentesco integer,id_pais integer,id_departamento integer,num integer,
        id_provincia integer,id_localidad integer,id_reservacion integer,embarazo integer,id_cargo integer,
        rango integer,id_seguro integer)
        order by fecha,nombres
    </select>  
  
    <select id="getAtendidosGeneral" resultMap="datosHistorialResumen">  
        select * from _verifica_fechageneral(#{cod_esta},#{fecha_ini},#{fecha_fin})  
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,id_tipo_parentesco integer,id_pais integer,id_departamento integer,num integer,
        id_provincia integer,id_localidad integer,id_reservacion integer,embarazo integer,id_cargo integer,
        rango integer,id_seguro integer)
    </select> 
 
    <select id="getAtendidosMicronutriente" resultMap="datosHistorialResumen">  
        select * from _verifica_fechamicro(#{fecha_ini},#{fecha_fin},#{id_cargo},#{cod_esta} ) 
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,id_tipo_parentesco integer,id_pais integer,id_departamento integer,num integer,
        id_provincia integer,id_localidad integer,id_reservacion integer,embarazo integer,id_cargo integer,
        rango integer,id_seguro integer)
    </select> 
 
  
    <resultMap id="datosAteVigencia"   type="Historiales">
        <result property="id_paciente"          column="id_paciente"/>  
        <result property="id_persona"           column="id_persona"/>
        <result property="id_historial"          column="id_historial"/>
        <result property="id_estado"             column="id_estado"/>
        <result property="nombres"               column="nombres"/> 
        <result property="hcl"                   column="hcl"/> 
        <result property="expedido"              column="expedido"/>            
        <result property="nro_registro"          column="nro_registro"/> 
        <result property="fecha"                 column="fecha"/>  
        <result property="fechalab"              column="fechalab"/>
        <result property="internado"             column="internado"/> 
        <result property="id_consultorio"        column="id_consultorio"/>    
        <result property="suma1"                 column="suma1"/>    
        <result property="suma2"                 column="suma2"/>
        <result property="suma3"                 column="suma3"/>
        <result property="suma4"                 column="suma4"/>
        <result property="suma5"                 column="suma5"/>
        <result property="suma6"                 column="suma6"/>
        <result property="suma7"                 column="suma7"/>
        <result property="suma8"                 column="suma8"/>
        <result property="suma9"                 column="suma9"/>
        <result property="suma10"                column="suma10"/>
        <result property="suma11"                column="suma11"/>
        <result property="nombre"                column="nombre"/>
        <result property="cadena1"               column="cadena1"/>  
        <result property="edad"                  column="edad"/> 
        <result property="mes"                   column="mes"/> 
        <result property="dia"                   column="dia"/> 
        <result property="subjetivo"             column="subjetivo"/> 
        <result property="objetivo"              column="objetivo"/>
        <result property="diagnostico"           column="diagnostico"/>
        <result property="accion"                column="accion"/>
        <result property="cadena1"               column="cadena1"/>
        <result property="cadena2"               column="cadena2"/>
        <result property="cadena3"               column="cadena3"/>
        <result property="registro"              column="registro"/>
        <result property="telefono"              column="telefono"/>
        <result property="carnet"                column="carnet"/>
        <result property="suma12"                column="suma12"/>
        <result property="tipoconsult"           column="tipoconsult"/>
        <result property="id_riesgo"             column="id_riesgo"/>
        <result property="cod_esta"              column="cod_esta"/>
    </resultMap>
  
    <select id="getVigencia_now" resultMap="datosAteVigencia">  
        SELECT id_paciente,id_historial,id_persona, id_estado, nombres, hcl, expedido, nro_registro, fecha, fechalab,
        internado, id_consultorio, suma1,suma2, suma3, suma4, suma5, suma6, suma7, suma8, suma9, suma10, suma11, 
        nombre,subjetivo, edad, mes,dia,cadena3, registro,objetivo,diagnostico, 
        cadena1,cadena2,telefono,accion,carnet,suma12,tipoconsult,id_riesgo, cod_esta
        FROM repor_atendidos
        WHERE fecha::timestamp>now()- interval '24 hour' and cod_esta=#{cod_esta} 
        order by fecha desc,id_historial limit 100;
        <!-- 09-05-2017 fecha::date between #{fecha_ini} and #{fecha_fin}-->
    </select>  
  
    <select id="getVigencia_now_triaje" resultMap="datosAteVigencia">  
        SELECT id_paciente,id_historial,h.id_persona, h.id_estado, p.nombres, hcl, expedido, nro_registro, fecha::timestamp without time zone, 
        (CASE WHEN fechavig is null THEN fecha::timestamp without time zone ELSE fechavig::timestamp without time zone END)  as fechalab,
        internado, h.id_consultorio, n_475 as suma1,n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, 
        n_c7 as suma8, n_cv as suma9, n_exa as suma10, n_ima as suma11, (e.paterno||' '||e.materno||' '||e.nombres)as nombre,subjetivo,
        extract(year from age( h.fecha,p.fec_nacimiento))::int  as edad, extract(month from age( h.fecha,p.fec_nacimiento))::int  as mes,
        extract(day from age( h.fecha,p.fec_nacimiento))::int  as dia,codcns as cadena3, codigoempresa as registro,objetivo,diagnostico, 
        nempresa as cadena1,seguro as cadena2,(CASE WHEN (p.telefono='' or p.telefono is null) THEN '0' ELSE p.telefono END) as telefono,
        accion,carnet,(CASE WHEN triaje is null THEN 0 ELSE triaje END) as suma12,tipoconsult,id_riesgo, h.cod_esta
        FROM historiales h
        join pacientes p using(id_paciente)
        join personas e using(id_persona)
        WHERE h.diagnostico!='Desde Farmacia' and fecha::timestamp>now()- interval '24 hour' and h.cod_esta=#{cod_esta} 
        order by fecha desc,id_historial limit 100;
        <!-- fecha::timestamp>now()- interval '24 hour' -->
    </select>  
    
    <select id="getVigenciaFecha" resultMap="datosAteVigencia">  
        SELECT id_paciente,id_historial,id_persona, id_estado, nombres, hcl, expedido, nro_registro, fecha, fechalab,
        internado, id_consultorio, suma1,suma2, suma3, suma4, suma5, suma6, suma7, suma8, suma9, suma10, suma11, 
        nombre,subjetivo, edad, mes,dia,cadena3, registro,objetivo,diagnostico, 
        cadena1,cadena2,telefono,accion,carnet,suma12,tipoconsult,id_riesgo, cod_esta
        FROM repor_atendidos
        WHERE fecha::date between #{fecha_ini} and #{fecha_fin} and cod_esta=#{cod_esta} 
        order by fecha desc,id_historial limit 100;
    </select>  
  
    <select id="getVigenciaFecha2" resultMap="datosAteVigencia">  
        SELECT id_paciente,id_historial,id_persona, id_estado, nombres, hcl, expedido, nro_registro, fecha, fechalab,
        internado, id_consultorio, suma1,suma2, suma3, suma4, suma5, suma6, suma7, suma8, suma9, suma10, suma11, 
        nombre,subjetivo, edad, mes,dia,cadena3, registro,objetivo,diagnostico, 
        cadena1,cadena2,telefono,accion,carnet,suma12,tipoconsult,id_riesgo, cod_esta
        FROM repor_atendidos
        WHERE fecha::date between #{fecha_ini} and #{fecha_fin} and cod_esta=#{cod_esta} 
        order by fecha desc,id_historial limit 100;
    </select>  
  
    <resultMap id="datosRecetasInternados"   type="Historiales">
        <result property="id_paciente"          column="id_paciente"/>
        <result property="id_historial"          column="id_historial"/>
        <result property="id_historia"          column="id_historia"/>
        <result property="nro_registro"          column="nro_registro"/> 
        <result property="carnet"                column="carnet"/> 
        <result property="telefono"              column="telefono"/> 
        <result property="nombres"               column="nombres"/> 
        <result property="nombre"                column="nombre"/> 
        <result property="edad"                  column="edad"/>      
        <result property="fecha"                 column="fecha"/>    
        <result property="sala"                  column="sala"/>
        <result property="cama"                  column="cama"/>
        <result property="piso"                  column="piso"/>
        <result property="expedido"              column="expedido"/>
        <result property="id_seguro"             column="id_seguro"/>
        <result property="seguro"                column="seguro"/>
        <result property="resultado"             column="resultado"/>
        <result property="diagnostico"           column="diagnostico"/>
        <result property="tipoconsult"           column="tipoconsult"/>
        <result property="id_riesgo"             column="id_riesgo"/>
        <result property="id_persona"            column="id_persona"/>
        <result property="cod_esta"              column="cod_esta"/>
    </resultMap>
  
    <select id="getRecetasInternados" resultMap="datosRecetasInternados">  
        select id_paciente,id_historial,id_historia,c.id_persona,fecha,nro_registro,p.telefono,carnet,p.nombres,seguro,edad,nempresa as resultado,
        h.cod_esta,camas.cama, h.diagnostico,h.id_seguro,expedido,salas.sala,pisos.piso,e.nombres||' '||e.paterno||' '||e.materno as nombre,
        tipoconsult,id_riesgo, h.cod_esta
        from historiales h 
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join camas on c.cama=id_cama
        inner join salas on c.sala=salas.id_sala
        inner join pisos on c.id_piso=pisos.id_piso
        where h.cod_esta=#{cod_esta} and id_historial in 
        (select id_historial from kardexpaciente where cod_esta=#{cod_esta} and id_estado=0 group by id_historial)
        order by id_historial
    </select>  
  
    <select id="getRecetasInternadosNombre" resultMap="datosRecetasInternados">  
        select id_paciente,id_historial,id_historia,c.id_persona,fecha,nro_registro,p.telefono,carnet,p.nombres,seguro,edad,nempresa as resultado,
        h.cod_esta,camas.cama, h.diagnostico,h.id_seguro,expedido,salas.sala,pisos.piso,e.nombres||' '||e.paterno||' '||e.materno as nombre,
        tipoconsult,id_riesgo, h.cod_esta
        from historiales h 
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join camas on c.cama=id_cama
        inner join salas on c.sala=salas.id_sala
        inner join pisos on c.id_piso=pisos.id_piso
        where h.cod_esta=#{cod_esta} and UPPER(p.nombres||nro_registro) ilike UPPER(#{nombres}) and id_historial in 
        (select id_historial from kardexpaciente where cod_esta=#{cod_esta} and id_estado=0 group by id_historial)
        order by id_historial
    </select>  
  
    <select id="getRecetasInternadosUnico" resultMap="datosRecetasInternados">  
        select id_paciente,id_historial,id_historia,c.id_persona,fecha,nro_registro,p.telefono,carnet,p.nombres,seguro,edad,nempresa as resultado,
        h.cod_esta,camas.cama, h.diagnostico,h.id_seguro,expedido,salas.sala,pisos.piso,e.nombres||' '||e.paterno||' '||e.materno as nombre,
        tipoconsult,id_riesgo, h.cod_esta
        from historiales h 
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join camas on c.cama=id_cama
        inner join salas on c.sala=salas.id_sala
        inner join pisos on c.id_piso=pisos.id_piso
        where h.cod_esta=#{cod_esta} and id_historial=#{id_historial} 
    </select>  
  
    <resultMap id="datosHistorialResid" type="Historiales">
        <result property="id_historial"          column="id_historial"/>
        <result property="id_estado"             column="id_estado"/>
        <result property="nombres"               column="nombres"/> 
        <result property="edad"                  column="edad"/>      
        <result property="expedido"              column="expedido"/>            
        <result property="fecha"                 column="fecha"/>    
        <result property="id_persona"            column="id_persona"/>  
        <result property="id_consultorio"        column="id_consultorio"/>    
        <result property="id_paciente"           column="id_paciente"/>    
        <result property="edad_ini"              column="edad_ini"/>     
        <result property="edad_fin"              column="edad_fin"/>     
        <result property="id_tipo_documento"     column="id_tipo_documento"/>    
        <result property="id_cargo"              column="id_cargo"/>   
        <result property="id_seguro"             column="id_seguro"/>
        <result property="nombre"                column="nombre"/>
        <result property="cadena"                column="cadena"/>
        <result property="suma1"                 column="suma1"/>
        <result property="suma2"                 column="suma2"/>
        <result property="cadena2"               column="cadena2"/>
        <result property="cadena3"               column="cadena3"/>
        <result property="cadena4"               column="cadena4"/>
        <result property="cadena5"               column="cadena5"/>
    </resultMap>
  
    <select id="getHistorialAtendidosHemo" resultMap="datosHistorialResid">  
        select * from _verifica_atencion_hemo(#{id_persona},#{cod_esta})  
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,suma2 integer,id_cargo integer,id_seguro integer,cadena2 text,cadena3 text,suma1 integer,cadena4 text, 
        cadena5 text,nombre text,cadena text)
        order by fecha desc
    </select> 
  
    <select id="getInternadosCajaObservacionHemo" resultMap="datosHistorialResid">  
        select * from _verifica_internados_observacion_hemo(#{id_consultorio},#{cod_esta})  
        as (id_historial integer,id_estado text,nombres text,edad integer,expedido text,fecha timestamp without time zone,
        id_persona integer,id_consultorio integer,id_paciente integer, edad_ini integer,edad_fin integer, 
        id_tipo_documento integer,suma2 integer,id_cargo integer,id_seguro integer,cadena2 text,cadena3 text,suma1 integer,cadena4 text, 
        cadena5 text,nombre text,cadena text)
        order by fecha desc
    </select> 
  
    <resultMap id="datosHistorialResumenI"   type="Historiales">
        <result property="id_historial"          column="id_historial"/>
        <result property="id_consultorio"        column="id_consultorio"/>    
        <result property="id_paciente"           column="id_paciente"/>   
        <result property="id_persona"            column="id_persona"/>  
        <result property="id_estado"             column="id_estado"/>
        <result property="nombres"               column="nombres"/> 
        <result property="edad"                  column="edad"/>      
        <result property="expedido"              column="expedido"/>            
        <result property="fecha"                 column="fecha"/>    
        <result property="talla"                 column="talla"/>  
        <result property="peso"                  column="peso"/> 
        <result property="temperatura"           column="temperatura"/> 
        <result property="fc"                    column="fc"/> 
        <result property="pa"                    column="pa"/> 
        <result property="fr"                    column="fr"/> 
        <result property="diagnostico"           column="diagnostico"/> 
        <result property="subjetivo"             column="subjetivo"/> 
        <result property="objetivo"              column="objetivo"/> 
        <result property="codigo"                column="codigo"/> 
        <result property="embarazo"              column="embarazo"/>
        <result property="id_seguro"             column="id_seguro"/>
        <result property="id_sala"               column="id_sala"/>
        <result property="id_cama"               column="id_cama"/>
        <result property="id_piso"               column="id_piso"/>
        <result property="sala"                  column="sala"/>
        <result property="cama"                  column="cama"/>
        <result property="piso"                  column="piso"/>
        <result property="carnet"                column="carnet"/>
        <result property="cadena1"               column="cadena1"/>
        <result property="cadena2"               column="cadena2"/>
        <result property="cadena3"               column="cadena3"/>
        <result property="cadena4"               column="cadena4"/>
        <result property="cadena5"               column="cadena5"/>
        <result property="cadena6"               column="cadena6"/>
        <result property="cadena7"               column="cadena7"/>
        <result property="suma1"                 column="suma1"/>
        <result property="suma2"                 column="suma2"/>
        <result property="suma3"                 column="suma3"/>
        <result property="suma4"                 column="suma4"/>
        <result property="suma5"                 column="suma5"/>
        <result property="suma6"                 column="suma6"/>
        <result property="suma7"                 column="suma7"/>
        <result property="suma8"                 column="suma8"/>
        <result property="suma9"                 column="suma9"/>
        <result property="suma10"                column="suma10"/>
        <result property="suma11"                column="suma11"/>
        <result property="suma12"                column="suma12"/>
        <result property="suma13"                column="suma13"/>
        <result property="tipoconsult"           column="tipoconsult"/>
        <result property="id_riesgo"             column="id_riesgo"/>
    </resultMap>
  
    <select id="getInternadosCajaObservacionPisoPer" resultMap="datosHistorialResumenI">
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorios.consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join consultorios on consultorios.id_consultorio=e.id_consultorio
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico not like '%Desde Farmacia%' and h.cod_esta=#{cod_esta} and h.id_persona=#{id_persona} and 
        fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
        and h.id_consultorio=#{id_consultorio} and  h.id_persona in 
        (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        order by fecha desc limit 20
    </select> 
  
    <select id="getHistorialAtendidosResidConsulPer" resultMap="datosHistorialResumenI">
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,0 as id_cama,
        0 as id_sala,0 as id_piso,'S'::text as sala,'S'::text as cama,'S'::text as piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        JOIN consultorios c USING(id_consultorio)
        JOIN personas e USING(id_persona)
        where h.diagnostico not like '%Desde Farmacia%' and h.id_persona=#{id_persona} and h.id_consultorio=#{id_consultorio} and 
        h.cod_esta=#{cod_esta} and fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
        and (internado between 0 and 1) and h.id_persona in (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        order by fecha desc limit 20
    </select> 
  
    <select id="getInternadosCajaObservacionPiso" resultMap="datosHistorialResumenI">
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorios.consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join consultorios on consultorios.id_consultorio=e.id_consultorio
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico not like '%Desde Farmacia%' and h.cod_esta=#{cod_esta} and h.id_consultorio=#{id_consultorio} and 
        fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours') 
        and  h.id_persona in 
        (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        order by fecha desc limit 20
    </select> 
  
    <select id="getHistorialAtendidosResidConsul" resultMap="datosHistorialResumenI">
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,0 as id_cama,
        0 as id_sala,0 as id_piso,'S'::text as sala,'S'::text as cama,'S'::text as piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        JOIN consultorios c USING(id_consultorio)
        JOIN personas e USING(id_persona)
        where h.diagnostico not like '%Desde Farmacia%' and h.id_consultorio=#{id_consultorio} and h.cod_esta=#{cod_esta} and 
        fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours') and 
        (internado between 0 and 1) and h.id_persona in (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        order by fecha desc limit 20
    </select> 
  
    <select id="getHistorialAtendidosResid" resultMap="datosHistorialResumenI">
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,0 as id_cama,
        0 as id_sala,0 as id_piso,'S'::text as sala,'S'::text as cama,'S'::text as piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        JOIN consultorios c USING(id_consultorio)
        JOIN personas e USING(id_persona)
        where h.diagnostico not like '%Desde Farmacia%' and h.cod_esta=#{cod_esta} and 
        fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours') and 
        (internado between 0 and 1) and id_persona in (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        order by fecha desc limit 20
    </select> 
  
    <select id="getInternadosCajaObservacion" resultMap="datosHistorialResumenI">
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorios.consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join consultorios on consultorios.id_consultorio=e.id_consultorio
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico!='Desde Farmacia' and h.cod_esta=#{cod_esta} and 
        fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
        and  h.id_persona in (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        order by fecha desc limit 20
    </select> 
  
    <select id="getInternadosCajaObservacionBuscar" resultMap="datosHistorialResumenI">  
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorios.consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join consultorios on consultorios.id_consultorio=e.id_consultorio
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where  h.diagnostico!='Desde Farmacia' and  h.cod_esta=#{cod_esta} and 
        fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours') 
        and  h.id_persona in  (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        and id_paciente in
        (select id_paciente from pacientes p join historiales using(id_paciente) 
        where p.id_estado like '%' and fecha::date between current_date-2 and current_date and cod_esta=#{cod_esta} 
        and texto_vector @@ to_tsquery('spanish', lower(#{cadena})  ) )
        order by fecha desc limit 20
    </select>  
  
    <select id="getHistorialAtendidosResidNombre" resultMap="datosHistorialResumenI">  
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,0 as id_cama,
        0 as id_sala,0 as id_piso,'S'::text as sala,'S'::text as cama,'S'::text as piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,consultorio as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 AS suma13,tipoconsult,id_riesgo
        from historiales h
        join pacientes p using(id_paciente)
        JOIN consultorios c USING(id_consultorio)
        JOIN personas e USING(id_persona)
        where h.diagnostico!='Desde Farmacia' and  h.cod_esta=#{cod_esta} and 
        fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours') and 
        (internado between 0 and 1) and id_persona in (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        and id_paciente in
        (select id_paciente from pacientes p join historiales using(id_paciente) 
        where fecha::timestamp between (now()::timestamp - interval '24 hours') and (now()::timestamp + interval '12 hours')
        and id_persona in 
        (select id_persona from personas where cod_esta=#{cod_esta} and urgencias=1)
        and cod_esta=#{cod_esta} and texto_vector @@ to_tsquery('spanish', lower(#{cadena})  ) )
        order by id_historial limit 20
    </select> 
  
    <select id="getInternados" resultMap="datosHistorialResumenI">  
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6,nro_registro as cadena2,codcns as cadena3,carnet,'S'::text as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 as suma13,tipoconsult,id_riesgo
        <!--
        (SELECT count(*) AS Expr1 FROM cuaderno5 c join historiales using(id_historial) 
                WHERE internado in (select id_tipoi from tipos_inter where internado between 0 and 3 ) and (c.id_persona = e.id_persona) ) AS suma13
        -->        
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico!='Desde Farmacia' and  h.cod_esta=#{cod_esta} and 
        internado in (select id_tipoi from tipos_inter where internado=#{suma1})
        order by fecha desc limit 20
    </select>  
  
    <select id="getInternadosPisoCaja" resultMap="datosHistorialResumenI">  
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,'S'::text as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12, 0 as suma13,tipoconsult,id_riesgo
        <!--
        (SELECT count(*) AS Expr1 FROM cuaderno5 c join historiales using(id_historial) 
                WHERE internado in (select id_tipoi from tipos_inter where internado between 0 and 3 ) and (c.id_persona = e.id_persona) ) AS suma13
        -->        
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico!='Desde Farmacia' and h.cod_esta=#{cod_esta} and c.id_piso=#{id_piso} and 
        internado in (select id_tipoi from tipos_inter where internado=2 )
        order by fecha desc limit 20
    </select>  
  
    <select id="getInternadosSalaCajaNombre" resultMap="datosHistorialResumenI">  
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,'S'::text as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12,   0 as suma13,tipoconsult,id_riesgo       
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico!='Desde Farmacia' and h.cod_esta=#{cod_esta} and  internado in (select id_tipoi from tipos_inter where internado=2 )
        and p.id_estado like '%' and p.texto_vector @@ to_tsquery('spanish', lower(#{cadena})  )
        order by fecha desc limit 15
    </select>
  
    <select id="getInternadosSalaCajaAltaNombre" resultMap="datosHistorialResumenI">  
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,'S'::text as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12,   0 as suma13    
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico!='Desde Farmacia' and h.cod_esta=#{cod_esta} and internado in 
        (select id_tipoi from tipos_inter where internado=3 ) and (fecha::date between current_date-30 and current_date) 
        and p.id_estado like '%' and p.texto_vector @@ to_tsquery('spanish', lower(#{cadena})  )
        order by fecha desc limit 20
    </select>
  
    <select id="getInternadosSala" resultMap="datosHistorialResumenI">  
        select id_historial,hcl,id_paciente,h.id_persona,h.id_consultorio,p.nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,
        h.diagnostico,codigo,expedido,accion,h.id_estado,expedido,embarazo,h.id_seguro,seguro as cadena1,c.cama as id_cama,
        c.sala as id_sala,c.id_piso,salas.sala, camas.cama,piso,nempresa  as cadena5,p.telefono as cadena4,
        e.nombres||' '||e.paterno||' '||e.materno as cadena6, nro_registro as cadena2,codcns as cadena3,carnet,'S'::text as cadena7,
        n_475 as suma1, n_rec as suma2, n_c1 as suma3, n_c2 as suma4, n_c3 as suma5, n_c4 as suma6, n_c5 as suma7, n_c6 as suma8, 
        n_c7 as suma9, n_cv as suma10, n_exa as suma11, n_ima as suma12,    0 as suma13,tipoconsult,id_riesgo
        <!--
        (SELECT count(*) AS Expr1 FROM cuaderno5 c join historiales using(id_historial) 
                WHERE internado in (select id_tipoi from tipos_inter where internado between 0 and 3 ) and (c.id_persona = e.id_persona) ) AS suma13
        -->        
        from historiales h
        join pacientes p using(id_paciente)
        join cuaderno5 c using(id_historial)
        inner join personas e on c.id_persona=e.id_persona
        inner join salas on salas.id_sala=c.sala
        inner join camas on camas.id_cama=c.cama
        inner join pisos on c.id_piso=pisos.id_piso
        where h.diagnostico!='Desde Farmacia' and h.cod_esta=#{cod_esta} and c.sala=#{id_sala} and c.id_piso=#{id_piso} and 
        internado in (select id_tipoi from tipos_inter where internado=2 )
        order by fecha desc limit 20
    </select>  

    <resultMap id="datosSumi" type="Historiales">
        <result property="fecha"                 column="fecha"/>  
        <result property="id_paciente"           column="id_paciente"/>
        <result property="edad_ini"              column="edad_ini"/>     
        <result property="edad_fin"              column="edad_fin"/>     
        <result property="id_provincia"          column="id_provincia"/>
        <result property="id_localidad"          column="id_localidad"/>
        <result property="num"                   column="num"/> 
        <result property="rango"                 column="rango"/>   
    </resultMap>
  
    <select id="getSumi" resultMap="datosSumi">  
        select fecha,sum(id_paciente) as id_paciente,sum(edad_ini) as edad_ini,sum(edad_fin) as edad_fin,sum(id_provincia) as id_provincia,sum(id_localidad) as id_localidad,sum(num) as num,sum(rango) as rango 
        from _prestaciones_sumi_fecha(#{fecha_ini},#{fecha_fin} ) 
        as (fecha date,id_paciente integer, edad_ini integer,edad_fin integer,id_provincia integer,id_localidad integer,num integer,rango integer)
        group by fecha order by fecha 
    </select> 
  
    <resultMap id="datosHistorialDia" type="Historiales">
        <result property="id_historial"      column="id_historial"/>       
        <result property="hcl"               column="hcl"/>   
        <result property="id_paciente"       column="id_paciente"/>    
        <result property="id_consultorio"    column="id_consultorio"/>    
        <result property="nombres"           column="nombres"/>    
        <result property="fecha"             column="fecha"/>    
        <result property="edad"              column="edad"/>   
        <result property="talla"             column="talla"/>
        <result property="peso"              column="peso"/>    
        <result property="temperatura"       column="temperatura"/>
        <result property="fc"                column="fc"/>
        <result property="pa"                column="pa"/>    
        <result property="fr"                column="fr"/>        
        <result property="subjetivo"         column="subjetivo"/>
        <result property="objetivo"          column="objetivo"/>    
        <result property="diagnostico"       column="diagnostico"/>
        <result property="codigo"            column="codigo"/>
        <result property="expedido"          column="expedido"/>            
        <result property="accion"            column="accion"/>
    </resultMap>
  
    <select id="getHistorialAtendidosH" resultMap="datosHistorialDia">  
        select id_historial,hcl,id_paciente,id_consultorio,nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,diagnostico,codigo,expedido,accion
        from historiales 
        join pacientes using(id_paciente)
        where fecha::date=current_date and id_persona=#{id_persona} 
        order by id_historial
    </select>   
   
    <select id="getHistorialAtendidosEco" resultMap="datosHistorialDia">  
        select id_historial,hcl,id_paciente,id_consultorio,nombres,fecha,edad,talla,peso,temperatura,fc,pa,fr,subjetivo,objetivo,diagnostico,codigo,expedido,accion
        from historiales 
        join pacientes using(id_paciente)
        where id_historial in (select id_historial from laboratorio where id_persona=#{id_persona} and fechae::date=current_date)
        order by id_historial
    </select>   
   
    <resultMap id="datosHistoImpDia" type="Historiales">
        <result property="id_historial"      column="id_historial"/>
        <result property="fecha"             column="fecha"/>
        <result property="nombres"           column="nombres"/>    
        <result property="nombre"            column="nombre"/>          
        <result property="hcl"               column="hcl"/>          
    </resultMap>
  
    <select id="getListaHistoriaImp" resultMap="datosHistoImpDia">  
        select id_historial,fecha::timestamp without time zone,pacientes.nombres, personas.nombres||' '||personas.paterno ||' '||personas.materno as nombre,hcl
        from historiales
        join pacientes using(id_paciente)
        join personas using (id_persona)
        where fecha::date>=current_date-1 and rango=#{rango} 
        order by 4,fecha,3
    </select> 
 
    <resultMap id="datosHistoCuenta" type="Historiales">
        <result property="num"      column="num"/>       
    </resultMap>
  
    <select id="getCuenta" resultMap="datosHistoCuenta">  
        select count(*) as num from historiales where codigo is not null and id_paciente=#{id_paciente} 
    </select>  
   
</mapper>